#!/bin/bash
# ç¯å¢ƒå˜é‡éªŒè¯è„šæœ¬
# ç”± Chezmoi ç®¡ç†ï¼Œåœ¨é…ç½®å˜æ›´æ—¶è¿è¡Œä»¥éªŒè¯ç¯å¢ƒè®¾ç½®

set -euo pipefail

echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡é…ç½®..."

# éªŒè¯åŸºç¡€è·¯å¾„å˜é‡ (Requirements: 2.4)
echo ""
echo "ğŸ“ åŸºç¡€è·¯å¾„å˜é‡:"
check_var() {
    local var_name="$1"
    local var_value="${!var_name:-}"
    local expected="$2"
    
    if [[ -n "$var_value" ]]; then
        if [[ "$var_value" == "$expected" ]]; then
            echo "  âœ… $var_name = $var_value"
        else
            echo "  âš ï¸  $var_name = $var_value (æœŸæœ›: $expected)"
        fi
    else
        echo "  âŒ $var_name æœªè®¾ç½® (æœŸæœ›: $expected)"
    fi
}

check_var "USER_HOME" "{{ .chezmoi.homeDir }}"
check_var "CONFIG_DIR" "{{ .paths.config }}"
check_var "LOCAL_BIN" "{{ .chezmoi.homeDir }}/.local/bin"

# éªŒè¯ç›®å½•æ˜¯å¦å­˜åœ¨
echo ""
echo "ğŸ“‚ ç›®å½•å­˜åœ¨æ€§æ£€æŸ¥:"
check_dir() {
    local dir_name="$1"
    local dir_path="$2"
    
    if [[ -d "$dir_path" ]]; then
        echo "  âœ… $dir_name: $dir_path"
    else
        echo "  âš ï¸  $dir_name ä¸å­˜åœ¨: $dir_path"
        mkdir -p "$dir_path" && echo "     å·²åˆ›å»ºç›®å½•"
    fi
}

check_dir "CONFIG_DIR" "{{ .paths.config }}"
check_dir "LOCAL_BIN" "{{ .chezmoi.homeDir }}/.local/bin"

# éªŒè¯ PATH é…ç½®
echo ""
echo "ğŸ›¤ï¸  PATH é…ç½®æ£€æŸ¥:"
if [[ ":$PATH:" == *":{{ .chezmoi.homeDir }}/.local/bin:"* ]]; then
    echo "  âœ… LOCAL_BIN å·²åœ¨ PATH ä¸­"
else
    echo "  âš ï¸  LOCAL_BIN ä¸åœ¨ PATH ä¸­"
fi

{{- if eq .chezmoi.os "darwin" }}
{{- if stat "/opt/homebrew" }}
if [[ ":$PATH:" == *":/opt/homebrew/bin:"* ]]; then
    echo "  âœ… Homebrew bin å·²åœ¨ PATH ä¸­"
else
    echo "  âš ï¸  Homebrew bin ä¸åœ¨ PATH ä¸­"
fi
{{- end }}
{{- else if eq .chezmoi.os "linux" }}
{{- if stat "/home/linuxbrew/.linuxbrew" }}
if [[ ":$PATH:" == *":/home/linuxbrew/.linuxbrew/bin:"* ]]; then
    echo "  âœ… Homebrew bin å·²åœ¨ PATH ä¸­"
else
    echo "  âš ï¸  Homebrew bin ä¸åœ¨ PATH ä¸­"
fi
{{- end }}
{{- end }}

# éªŒè¯ç¼–è¾‘å™¨é…ç½®
echo ""
echo "âœï¸  ç¼–è¾‘å™¨é…ç½®:"
check_var "EDITOR" "{{ .preferences.editor }}"
check_var "VISUAL" "{{ .preferences.editor }}"

if command -v "{{ .preferences.editor }}" >/dev/null 2>&1; then
    echo "  âœ… ç¼–è¾‘å™¨ {{ .preferences.editor }} å¯ç”¨"
else
    echo "  âš ï¸  ç¼–è¾‘å™¨ {{ .preferences.editor }} ä¸å¯ç”¨"
fi

# éªŒè¯è¯­è¨€å’ŒåŒºåŸŸé…ç½® (Requirements: 2.4)
echo ""
echo "ğŸŒ è¯­è¨€å’ŒåŒºåŸŸé…ç½®:"
check_var "LANG" "en_US.UTF-8"
check_var "LC_ALL" "en_US.UTF-8"
check_var "LC_CTYPE" "en_US.UTF-8"

# éªŒè¯å½“å‰ locale è®¾ç½®
if command -v locale >/dev/null 2>&1; then
    current_lang=$(locale | grep "LANG=" | cut -d= -f2 | tr -d '"')
    if [[ "$current_lang" == "en_US.UTF-8" ]]; then
        echo "  âœ… ç³»ç»Ÿ LANG è®¾ç½®æ­£ç¡®: $current_lang"
    else
        echo "  âš ï¸  ç³»ç»Ÿ LANG è®¾ç½®: $current_lang (æœŸæœ›: en_US.UTF-8)"
    fi
fi

{{- if and (hasKey . "features") .features.enable_1password }}
# éªŒè¯ SSH Agent é…ç½® (Requirements: 7.2)
echo ""
echo "ğŸ” SSH Agent é…ç½® (1Password):"
{{- if eq .chezmoi.os "darwin" }}
SSH_AGENT_EXPECTED="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else if eq .chezmoi.os "linux" }}
SSH_AGENT_EXPECTED="$HOME/.1password/agent.sock"
{{- end }}
check_var "SSH_AUTH_SOCK" "$SSH_AGENT_EXPECTED"

if [[ -S "$SSH_AGENT_EXPECTED" ]]; then
    echo "  âœ… SSH Agent å¥—æ¥å­—å­˜åœ¨"
    
    # æµ‹è¯• SSH Agent è¿æ¥
    if ssh-add -l >/dev/null 2>&1; then
        echo "  âœ… SSH Agent è¿æ¥æ­£å¸¸"
        key_count=$(ssh-add -l | wc -l)
        echo "  â„¹ï¸  å·²åŠ è½½ $key_count ä¸ª SSH å¯†é’¥"
    else
        echo "  âš ï¸  SSH Agent è¿æ¥å¤±è´¥"
    fi
else
    echo "  âš ï¸  SSH Agent å¥—æ¥å­—ä¸å­˜åœ¨: $SSH_AGENT_EXPECTED"
fi
{{- end }}

# éªŒè¯å¹³å°ç‰¹å®šé…ç½®
echo ""
echo "ğŸ–¥ï¸  å¹³å°ç‰¹å®šé…ç½®:"
echo "  å¹³å°: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo "  ç¯å¢ƒ: {{ .environment }}"
echo "  åŒ…ç®¡ç†å™¨: {{ .package_manager }}"

{{- if eq .chezmoi.os "darwin" }}
{{- if stat "/opt/homebrew" }}
echo "  Homebrew å‰ç¼€: /opt/homebrew"
if [[ -x "/opt/homebrew/bin/brew" ]]; then
    echo "  âœ… Homebrew å¯ç”¨"
else
    echo "  âš ï¸  Homebrew ä¸å¯ç”¨"
fi
{{- end }}
{{- else if eq .chezmoi.os "linux" }}
{{- if stat "/home/linuxbrew/.linuxbrew" }}
echo "  Homebrew å‰ç¼€: /home/linuxbrew/.linuxbrew"
if [[ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
    echo "  âœ… Homebrew å¯ç”¨"
else
    echo "  âš ï¸  Homebrew ä¸å¯ç”¨"
fi
{{- end }}
{{- end }}

# éªŒè¯ Shell ç‰¹å®šé…ç½®
echo ""
echo "ğŸš Shell é…ç½®:"
echo "  å½“å‰ Shell: $SHELL"
echo "  é¦–é€‰ Shell: {{ .preferences.shell }}"

{{- if eq .preferences.shell "zsh" }}
if [[ -n "${ZSH_VERSION:-}" ]]; then
    echo "  âœ… è¿è¡Œåœ¨ Zsh ä¸­"
    echo "  Zsh ç‰ˆæœ¬: $ZSH_VERSION"
    
    # æ£€æŸ¥ Zsh ç‰¹å®šå˜é‡
    if [[ -n "${HISTFILE:-}" ]]; then
        echo "  âœ… HISTFILE å·²è®¾ç½®: $HISTFILE"
    fi
else
    echo "  â„¹ï¸  å½“å‰ä¸åœ¨ Zsh ä¸­è¿è¡Œ"
fi
{{- end }}

# æ€§èƒ½æ£€æŸ¥
echo ""
echo "âš¡ æ€§èƒ½é…ç½®:"
{{- if eq .environment "remote" }}
echo "  ç¯å¢ƒç±»å‹: è¿œç¨‹ (æ€§èƒ½ä¼˜åŒ–æ¨¡å¼)"
if [[ "${SHELLRC_FAST_MODE:-}" == "true" ]]; then
    echo "  âœ… å¿«é€Ÿæ¨¡å¼å·²å¯ç”¨"
fi
{{- else }}
echo "  ç¯å¢ƒç±»å‹: æœ¬åœ° (å®Œæ•´åŠŸèƒ½æ¨¡å¼)"
{{- end }}

echo ""
echo "ğŸ‰ ç¯å¢ƒå˜é‡éªŒè¯å®Œæˆ"

# ç”Ÿæˆé…ç½®æ‘˜è¦
echo ""
echo "ğŸ“‹ é…ç½®æ‘˜è¦:"
echo "  ç”¨æˆ·ä¸»ç›®å½•: {{ .chezmoi.homeDir }}"
echo "  é…ç½®ç›®å½•: {{ .paths.config }}"
echo "  æœ¬åœ°äºŒè¿›åˆ¶ç›®å½•: {{ .chezmoi.homeDir }}/.local/bin"
echo "  ç¼–è¾‘å™¨: {{ .preferences.editor }}"
echo "  è¯­è¨€: en_US.UTF-8"
{{- if and (hasKey . "features") .features.enable_1password }}
{{- if eq .chezmoi.os "darwin" }}
echo "  SSH Agent: 1Password ($HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock)"
{{- else if eq .chezmoi.os "linux" }}
echo "  SSH Agent: 1Password ($HOME/.1password/agent.sock)"
{{- end }}
{{- end }}
echo "  å¹³å°: {{ .chezmoi.os }}"
echo "  ç¯å¢ƒ: {{ .environment }}"

# æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½ shell
if [[ "${USER_HOME:-}" != "{{ .chezmoi.homeDir }}" ]] || \
   [[ "${CONFIG_DIR:-}" != "{{ .paths.config }}" ]] || \
   [[ "${EDITOR:-}" != "{{ .preferences.editor }}" ]]; then
    echo ""
    echo "âš ï¸  æ£€æµ‹åˆ°ç¯å¢ƒå˜é‡ä¸åŒ¹é…ï¼Œå»ºè®®é‡æ–°åŠ è½½ shell é…ç½®:"
    echo "   source ~/.zshrc  # æˆ–"
    echo "   source ~/.bashrc"
fi