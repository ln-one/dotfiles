#!/bin/bash
# Environment variable verification script
# Managed by Chezmoi, runs on config changes to verify environment setup

set -euo pipefail

echo "Verifying Homebrew environment configuration..."

# Get Homebrew prefix
{{- if eq .chezmoi.os "darwin" }}
HOMEBREW_PREFIX="/opt/homebrew"
{{- else if eq .chezmoi.os "linux" }}
HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
{{- end }}

# Verify Homebrew installation and path
echo ""
echo "Homebrew configuration check:"
if [[ -x "$HOMEBREW_PREFIX/bin/brew" ]]; then
    echo "  Homebrew is installed: $HOMEBREW_PREFIX"
    
    # Verify Homebrew is in PATH
    if [[ ":$PATH:" == *":$HOMEBREW_PREFIX/bin:"* ]]; then
        echo "  Homebrew bin is in PATH"
    else
        echo "  Warning: Homebrew bin is not in PATH"
    fi
    
    # Verify Homebrew environment variable
    if [[ "${HOMEBREW_PREFIX:-}" == "$HOMEBREW_PREFIX" ]]; then
        echo "  HOMEBREW_PREFIX is set"
    else
        echo "  Warning: HOMEBREW_PREFIX is not set correctly"
    fi
else
    echo "  Homebrew is not installed or unavailable: $HOMEBREW_PREFIX"
    echo "     Please install Homebrew: https://brew.sh"
    exit 1
fi

# Verify core tools (installed via Homebrew)
echo ""
echo "Core tools verification:"
check_homebrew_tool() {
    local tool_name="$1"
    local tool_path="$HOMEBREW_PREFIX/bin/$tool_name"
    
    if [[ -x "$tool_path" ]]; then
        echo "  $tool_name is available ($tool_path)"
    else
        echo "  Warning: $tool_name is not available, please run: brew install $tool_name"
    fi
}

# Check common tools
check_homebrew_tool "git"
check_homebrew_tool "curl"
check_homebrew_tool "bat"
check_homebrew_tool "fd"
check_homebrew_tool "eza"
check_homebrew_tool "ripgrep"

# Verify editor (assumed installed via Homebrew)
echo ""
echo "Editor configuration:"
EDITOR_NAME="{{ .preferences.editor }}"
if [[ -x "$HOMEBREW_PREFIX/bin/$EDITOR_NAME" ]] || command -v "$EDITOR_NAME" >/dev/null 2>&1; then
    echo "  Editor $EDITOR_NAME is available"
else
    echo "  Warning: Editor $EDITOR_NAME is not available, please run: brew install $EDITOR_NAME"
fi

{{- if and (hasKey . "features") .features.enable_1password }}
# Verify 1Password CLI (if enabled)
if [[ -x "$HOMEBREW_PREFIX/bin/op" ]]; then
    echo "  1Password CLI is available"
else
    echo "  Warning: 1Password CLI is not available, please run: brew install 1password-cli"
fi
{{- end }}

echo ""
echo "Homebrew environment verification complete"

# Generate configuration summary
echo ""
echo "Configuration summary:"
echo "  Homebrew prefix: $HOMEBREW_PREFIX"
echo "  Platform: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo "  Editor: {{ .preferences.editor }}"

# Advise user if tools are missing
echo ""
echo "If any tools are missing, please run the following command to install:"
echo "   brew bundle install --file=Brewfile"