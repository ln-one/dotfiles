#!/bin/bash
# ç¯å¢ƒå˜é‡éªŒè¯è„šæœ¬
# ç”± Chezmoi ç®¡ç†ï¼Œåœ¨é…ç½®å˜æ›´æ—¶è¿è¡Œä»¥éªŒè¯ç¯å¢ƒè®¾ç½®

set -euo pipefail

echo "ğŸ” éªŒè¯ Homebrew ç¯å¢ƒé…ç½®..."

# è·å– Homebrew å‰ç¼€
{{- if eq .chezmoi.os "darwin" }}
HOMEBREW_PREFIX="/opt/homebrew"
{{- else if eq .chezmoi.os "linux" }}
HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
{{- end }}

# éªŒè¯ Homebrew å®‰è£…å’Œè·¯å¾„
echo ""
echo "ğŸº Homebrew é…ç½®æ£€æŸ¥:"
if [[ -x "$HOMEBREW_PREFIX/bin/brew" ]]; then
    echo "  âœ… Homebrew å·²å®‰è£…: $HOMEBREW_PREFIX"
    
    # éªŒè¯ Homebrew åœ¨ PATH ä¸­
    if [[ ":$PATH:" == *":$HOMEBREW_PREFIX/bin:"* ]]; then
        echo "  âœ… Homebrew bin å·²åœ¨ PATH ä¸­"
    else
        echo "  âš ï¸  Homebrew bin ä¸åœ¨ PATH ä¸­"
    fi
    
    # éªŒè¯ Homebrew ç¯å¢ƒå˜é‡
    if [[ "${HOMEBREW_PREFIX:-}" == "$HOMEBREW_PREFIX" ]]; then
        echo "  âœ… HOMEBREW_PREFIX å·²è®¾ç½®"
    else
        echo "  âš ï¸  HOMEBREW_PREFIX æœªæ­£ç¡®è®¾ç½®"
    fi
else
    echo "  âŒ Homebrew æœªå®‰è£…æˆ–ä¸å¯ç”¨: $HOMEBREW_PREFIX"
    echo "     è¯·å…ˆå®‰è£… Homebrew: https://brew.sh"
    exit 1
fi

# éªŒè¯æ ¸å¿ƒå·¥å…· (é€šè¿‡ Homebrew å®‰è£…)
echo ""
echo "ğŸ”§ æ ¸å¿ƒå·¥å…·éªŒè¯:"
check_homebrew_tool() {
    local tool_name="$1"
    local tool_path="$HOMEBREW_PREFIX/bin/$tool_name"
    
    if [[ -x "$tool_path" ]]; then
        echo "  âœ… $tool_name å¯ç”¨ ($tool_path)"
    else
        echo "  âš ï¸  $tool_name ä¸å¯ç”¨ï¼Œè¯·è¿è¡Œ: brew install $tool_name"
    fi
}

# æ£€æŸ¥å¸¸ç”¨å·¥å…·
check_homebrew_tool "git"
check_homebrew_tool "curl"
check_homebrew_tool "bat"
check_homebrew_tool "fd"
check_homebrew_tool "eza"
check_homebrew_tool "ripgrep"

# éªŒè¯ç¼–è¾‘å™¨ (å‡è®¾é€šè¿‡ Homebrew å®‰è£…)
echo ""
echo "âœï¸  ç¼–è¾‘å™¨é…ç½®:"
EDITOR_NAME="{{ .preferences.editor }}"
if [[ -x "$HOMEBREW_PREFIX/bin/$EDITOR_NAME" ]] || command -v "$EDITOR_NAME" >/dev/null 2>&1; then
    echo "  âœ… ç¼–è¾‘å™¨ $EDITOR_NAME å¯ç”¨"
else
    echo "  âš ï¸  ç¼–è¾‘å™¨ $EDITOR_NAME ä¸å¯ç”¨ï¼Œè¯·è¿è¡Œ: brew install $EDITOR_NAME"
fi

{{- if and (hasKey . "features") .features.enable_1password }}
# éªŒè¯ 1Password CLI (å¦‚æœå¯ç”¨)
if [[ -x "$HOMEBREW_PREFIX/bin/op" ]]; then
    echo "  âœ… 1Password CLI å¯ç”¨"
else
    echo "  âš ï¸  1Password CLI ä¸å¯ç”¨ï¼Œè¯·è¿è¡Œ: brew install 1password-cli"
fi
{{- end }}

echo ""
echo "ğŸ‰ Homebrew ç¯å¢ƒéªŒè¯å®Œæˆ"

# ç”Ÿæˆé…ç½®æ‘˜è¦
echo ""
echo "ğŸ“‹ é…ç½®æ‘˜è¦:"
echo "  Homebrew å‰ç¼€: $HOMEBREW_PREFIX"
echo "  å¹³å°: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo "  ç¼–è¾‘å™¨: {{ .preferences.editor }}"

# æç¤ºç”¨æˆ·å¦‚æœæœ‰å·¥å…·ç¼ºå¤±
echo ""
echo "ğŸ’¡ å¦‚æœæœ‰å·¥å…·ç¼ºå¤±ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…:"
echo "   brew bundle install --file=Brewfile"