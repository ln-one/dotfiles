#!/bin/bash
# 环境变量验证脚本
# 由 Chezmoi 管理，在配置变更时运行以验证环境设置

set -euo pipefail

echo "🔍 验证 Homebrew 环境配置..."

# 获取 Homebrew 前缀
{{- if eq .chezmoi.os "darwin" }}
HOMEBREW_PREFIX="/opt/homebrew"
{{- else if eq .chezmoi.os "linux" }}
HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
{{- end }}

# 验证 Homebrew 安装和路径
echo ""
echo "🍺 Homebrew 配置检查:"
if [[ -x "$HOMEBREW_PREFIX/bin/brew" ]]; then
    echo "  ✅ Homebrew 已安装: $HOMEBREW_PREFIX"
    
    # 验证 Homebrew 在 PATH 中
    if [[ ":$PATH:" == *":$HOMEBREW_PREFIX/bin:"* ]]; then
        echo "  ✅ Homebrew bin 已在 PATH 中"
    else
        echo "  ⚠️  Homebrew bin 不在 PATH 中"
    fi
    
    # 验证 Homebrew 环境变量
    if [[ "${HOMEBREW_PREFIX:-}" == "$HOMEBREW_PREFIX" ]]; then
        echo "  ✅ HOMEBREW_PREFIX 已设置"
    else
        echo "  ⚠️  HOMEBREW_PREFIX 未正确设置"
    fi
else
    echo "  ❌ Homebrew 未安装或不可用: $HOMEBREW_PREFIX"
    echo "     请先安装 Homebrew: https://brew.sh"
    exit 1
fi

# 验证核心工具 (通过 Homebrew 安装)
echo ""
echo "🔧 核心工具验证:"
check_homebrew_tool() {
    local tool_name="$1"
    local tool_path="$HOMEBREW_PREFIX/bin/$tool_name"
    
    if [[ -x "$tool_path" ]]; then
        echo "  ✅ $tool_name 可用 ($tool_path)"
    else
        echo "  ⚠️  $tool_name 不可用，请运行: brew install $tool_name"
    fi
}

# 检查常用工具
check_homebrew_tool "git"
check_homebrew_tool "curl"
check_homebrew_tool "bat"
check_homebrew_tool "fd"
check_homebrew_tool "eza"
check_homebrew_tool "ripgrep"

# 验证编辑器 (假设通过 Homebrew 安装)
echo ""
echo "✏️  编辑器配置:"
EDITOR_NAME="{{ .preferences.editor }}"
if [[ -x "$HOMEBREW_PREFIX/bin/$EDITOR_NAME" ]] || command -v "$EDITOR_NAME" >/dev/null 2>&1; then
    echo "  ✅ 编辑器 $EDITOR_NAME 可用"
else
    echo "  ⚠️  编辑器 $EDITOR_NAME 不可用，请运行: brew install $EDITOR_NAME"
fi

{{- if and (hasKey . "features") .features.enable_1password }}
# 验证 1Password CLI (如果启用)
if [[ -x "$HOMEBREW_PREFIX/bin/op" ]]; then
    echo "  ✅ 1Password CLI 可用"
else
    echo "  ⚠️  1Password CLI 不可用，请运行: brew install 1password-cli"
fi
{{- end }}

echo ""
echo "🎉 Homebrew 环境验证完成"

# 生成配置摘要
echo ""
echo "📋 配置摘要:"
echo "  Homebrew 前缀: $HOMEBREW_PREFIX"
echo "  平台: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo "  编辑器: {{ .preferences.editor }}"

# 提示用户如果有工具缺失
echo ""
echo "💡 如果有工具缺失，请运行以下命令安装:"
echo "   brew bundle install --file=Brewfile"