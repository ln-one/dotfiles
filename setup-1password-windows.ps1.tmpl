{{- if and (eq .chezmoi.os "windows") .features.enable_1password -}}
# 1Password Windows Setup Helper
# Helps configure 1Password CLI and SSH Agent on Windows

Write-Host "1Password Windows Setup Helper" -ForegroundColor Cyan
Write-Host "==============================" -ForegroundColor Cyan

# Check if 1Password CLI is installed
if (-not (Get-Command op -ErrorAction SilentlyContinue)) {
    Write-Host "1Password CLI not found. Installing via winget..." -ForegroundColor Yellow
    try {
        winget install --id AgileBits.1Password.CLI --silent --accept-package-agreements
        Write-Host "1Password CLI installed successfully!" -ForegroundColor Green
    } catch {
        Write-Error "Failed to install 1Password CLI: $_"
        exit 1
    }
}

# Check 1Password authentication
Write-Host "Checking 1Password authentication..." -ForegroundColor Yellow
try {
    $accounts = op account list --format=json 2>$null | ConvertFrom-Json
    if ($accounts) {
        Write-Host "1Password CLI is authenticated!" -ForegroundColor Green
        $accounts | ForEach-Object {
            Write-Host "  Account: $($_.user_name)@$($_.domain)" -ForegroundColor Cyan
        }
    } else {
        Write-Host "1Password CLI needs authentication." -ForegroundColor Yellow
        Write-Host "Please run: op signin" -ForegroundColor Cyan
    }
} catch {
    Write-Host "1Password CLI needs authentication." -ForegroundColor Yellow
    Write-Host "Please run: op signin" -ForegroundColor Cyan
}

# Check SSH Agent
Write-Host "Checking 1Password SSH Agent..." -ForegroundColor Yellow
$sshAgentSock = "$env:USERPROFILE\AppData\Local\1Password\agent.sock"
if (Test-Path $sshAgentSock) {
    Write-Host "1Password SSH Agent is available!" -ForegroundColor Green
} else {
    Write-Host "1Password SSH Agent not found." -ForegroundColor Yellow
    Write-Host "Please enable SSH Agent in 1Password:" -ForegroundColor Cyan
    Write-Host "  1. Open 1Password desktop app" -ForegroundColor White
    Write-Host "  2. Go to Settings > Developer" -ForegroundColor White
    Write-Host "  3. Enable 'Use the SSH agent'" -ForegroundColor White
}

Write-Host ""
Write-Host "Setup complete! Restart your terminal to apply changes." -ForegroundColor Green
{{- end -}}