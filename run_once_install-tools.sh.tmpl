#!/bin/bash
# å·¥å…·è‡ªåŠ¨å®‰è£…è„šæœ¬
# æ£€æµ‹å¹¶å®‰è£…å¿…éœ€çš„å¼€å‘å·¥å…·ï¼Œæ”¯æŒè·¨å¹³å°æ¡ä»¶å®‰è£…
# Requirements: 4.3, 8.2

set -euo pipefail

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

log_success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# å…¨å±€å˜é‡
PLATFORM="{{ .chezmoi.os }}"
ARCH="{{ .chezmoi.arch }}"
ENVIRONMENT="{{ .environment }}"
PACKAGE_MANAGER="{{ .package_manager }}"

# å¿…éœ€å·¥å…·åˆ—è¡¨ - æŒ‰ä¼˜å…ˆçº§åˆ†ç»„
declare -A ESSENTIAL_TOOLS=(
    ["git"]="ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ"
    ["curl"]="HTTP å®¢æˆ·ç«¯"
    ["wget"]="æ–‡ä»¶ä¸‹è½½å·¥å…·"
    ["unzip"]="å‹ç¼©æ–‡ä»¶å¤„ç†"
)

declare -A MODERN_CLI_TOOLS=(
    ["eza"]="ç°ä»£åŒ– ls æ›¿ä»£å“"
    ["bat"]="ç°ä»£åŒ– cat æ›¿ä»£å“" 
    ["fd"]="ç°ä»£åŒ– find æ›¿ä»£å“"
    ["ripgrep"]="ç°ä»£åŒ– grep æ›¿ä»£å“"
    ["fzf"]="æ¨¡ç³Šæœç´¢å·¥å…·"
    ["jq"]="JSON å¤„ç†å·¥å…·"
)

declare -A DEVELOPMENT_TOOLS=(
    ["neovim"]="ç°ä»£åŒ–ç¼–è¾‘å™¨"
    ["tmux"]="ç»ˆç«¯å¤ç”¨å™¨"
    ["htop"]="ç³»ç»Ÿç›‘æ§å·¥å…·"
    ["tree"]="ç›®å½•æ ‘æ˜¾ç¤º"
)

{{- if .features.enable_node }}
declare -A NODE_TOOLS=(
    ["node"]="Node.js è¿è¡Œæ—¶"
    ["npm"]="Node åŒ…ç®¡ç†å™¨"
)
{{- end }}

{{- if .features.enable_python }}
declare -A PYTHON_TOOLS=(
    ["python3"]="Python 3 è§£é‡Šå™¨"
    ["pip3"]="Python åŒ…ç®¡ç†å™¨"
)
{{- end }}

# æ£€æŸ¥å·¥å…·æ˜¯å¦å·²å®‰è£…
check_tool_installed() {
    local tool="$1"
    if command -v "$tool" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# è·å–å·¥å…·ç‰ˆæœ¬ä¿¡æ¯
get_tool_version() {
    local tool="$1"
    case "$tool" in
        "git")
            git --version 2>/dev/null | head -n1 || echo "æœªçŸ¥ç‰ˆæœ¬"
            ;;
        "node")
            node --version 2>/dev/null || echo "æœªçŸ¥ç‰ˆæœ¬"
            ;;
        "python3")
            python3 --version 2>/dev/null || echo "æœªçŸ¥ç‰ˆæœ¬"
            ;;
        "neovim")
            nvim --version 2>/dev/null | head -n1 || echo "æœªçŸ¥ç‰ˆæœ¬"
            ;;
        *)
            $tool --version 2>/dev/null | head -n1 || echo "å·²å®‰è£…"
            ;;
    esac
}

# ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…å·¥å…·
install_with_system_package_manager() {
    local tool="$1"
    local description="$2"
    
    log_info "ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£… $tool ($description)..."
    
    case "$PACKAGE_MANAGER" in
        "apt")
            # Ubuntu/Debian åŒ…åæ˜ å°„
            case "$tool" in
                "eza") 
                    # eza åœ¨ Ubuntu 24.04+ å¯ç”¨ï¼Œå¦åˆ™ä½¿ç”¨ exa
                    if sudo apt-get install -y eza 2>/dev/null; then
                        return 0
                    else
                        log_warn "eza ä¸å¯ç”¨ï¼Œå°è¯•å®‰è£… exa..."
                        sudo apt-get install -y exa || return 1
                    fi
                    ;;
                "bat")
                    sudo apt-get install -y batcat || return 1
                    # åˆ›å»º bat åˆ«åæŒ‡å‘ batcat
                    if [[ ! -L "$HOME/.local/bin/bat" ]]; then
                        mkdir -p "$HOME/.local/bin"
                        ln -sf /usr/bin/batcat "$HOME/.local/bin/bat"
                    fi
                    ;;
                "fd")
                    sudo apt-get install -y fd-find || return 1
                    # åˆ›å»º fd åˆ«åæŒ‡å‘ fdfind
                    if [[ ! -L "$HOME/.local/bin/fd" ]]; then
                        mkdir -p "$HOME/.local/bin"
                        ln -sf /usr/bin/fdfind "$HOME/.local/bin/fd"
                    fi
                    ;;
                "ripgrep")
                    sudo apt-get install -y ripgrep || return 1
                    ;;
                "neovim")
                    sudo apt-get install -y neovim || return 1
                    ;;
                *)
                    sudo apt-get install -y "$tool" || return 1
                    ;;
            esac
            ;;
        "yum"|"dnf")
            local pkg_cmd="$PACKAGE_MANAGER"
            case "$tool" in
                "eza"|"bat"|"fd")
                    log_warn "$tool åœ¨ $PACKAGE_MANAGER ä¸­å¯èƒ½ä¸å¯ç”¨ï¼Œå»ºè®®ä½¿ç”¨ Homebrew"
                    return 1
                    ;;
                *)
                    sudo $pkg_cmd install -y "$tool" || return 1
                    ;;
            esac
            ;;
        *)
            log_warn "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨: $PACKAGE_MANAGER"
            return 1
            ;;
    esac
}

# ä½¿ç”¨ Homebrew å®‰è£…å·¥å…·
install_with_homebrew() {
    local tool="$1"
    local description="$2"
    
    if ! command -v brew >/dev/null 2>&1; then
        log_warn "Homebrew æœªå®‰è£…ï¼Œè·³è¿‡ $tool"
        return 1
    fi
    
    log_info "ä½¿ç”¨ Homebrew å®‰è£… $tool ($description)..."
    brew install "$tool" || return 1
}

# å®‰è£…å•ä¸ªå·¥å…·
install_tool() {
    local tool="$1"
    local description="$2"
    local install_method="${3:-auto}"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if check_tool_installed "$tool"; then
        local version=$(get_tool_version "$tool")
        log_success "âœ… $tool å·²å®‰è£… - $description ($version)"
        return 0
    fi
    
    log_step "å®‰è£… $tool - $description"
    
    # æ ¹æ®å®‰è£…æ–¹æ³•å’Œå¹³å°é€‰æ‹©å®‰è£…ç­–ç•¥
    case "$install_method" in
        "homebrew")
            install_with_homebrew "$tool" "$description"
            ;;
        "system")
            install_with_system_package_manager "$tool" "$description"
            ;;
        "auto")
            # è‡ªåŠ¨é€‰æ‹©æœ€ä½³å®‰è£…æ–¹æ³•
            if [[ "$PLATFORM" == "darwin" ]]; then
                # macOS ä¼˜å…ˆä½¿ç”¨ Homebrew
                install_with_homebrew "$tool" "$description" || \
                install_with_system_package_manager "$tool" "$description"
            else
                # Linux ä¼˜å…ˆä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨ï¼Œå¤±è´¥åå°è¯• Homebrew
                install_with_system_package_manager "$tool" "$description" || \
                install_with_homebrew "$tool" "$description"
            fi
            ;;
        *)
            log_error "æœªçŸ¥çš„å®‰è£…æ–¹æ³•: $install_method"
            return 1
            ;;
    esac
    
    # éªŒè¯å®‰è£…ç»“æœ
    if check_tool_installed "$tool"; then
        local version=$(get_tool_version "$tool")
        log_success "âœ… $tool å®‰è£…æˆåŠŸ - $description ($version)"
        return 0
    else
        log_error "âŒ $tool å®‰è£…å¤±è´¥ - $description"
        return 1
    fi
}

# å®‰è£…å·¥å…·ç»„
install_tool_group() {
    local -n tools_ref=$1
    local group_name="$2"
    local install_method="${3:-auto}"
    
    log_step "å®‰è£… $group_name"
    
    local failed_tools=()
    local installed_count=0
    local total_count=${#tools_ref[@]}
    
    for tool in "${!tools_ref[@]}"; do
        local description="${tools_ref[$tool]}"
        
        if install_tool "$tool" "$description" "$install_method"; then
            ((installed_count++))
        else
            failed_tools+=("$tool")
        fi
    done
    
    # æ˜¾ç¤ºç»„å®‰è£…ç»“æœ
    if [[ ${#failed_tools[@]} -eq 0 ]]; then
        log_success "ğŸ‰ $group_name å…¨éƒ¨å®‰è£…æˆåŠŸ ($installed_count/$total_count)"
    else
        log_warn "âš ï¸ $group_name éƒ¨åˆ†å®‰è£…å¤±è´¥: ${failed_tools[*]} ($installed_count/$total_count)"
    fi
    
    return ${#failed_tools[@]}
}

# æ›´æ–°ç³»ç»ŸåŒ…ç®¡ç†å™¨
update_system_packages() {
    log_step "æ›´æ–°ç³»ç»ŸåŒ…ç®¡ç†å™¨..."
    
    case "$PACKAGE_MANAGER" in
        "apt")
            sudo apt-get update || log_warn "apt æ›´æ–°å¤±è´¥"
            ;;
        "yum")
            sudo yum check-update || true  # yum check-update è¿”å›éé›¶å€¼æ˜¯æ­£å¸¸çš„
            ;;
        "dnf")
            sudo dnf check-update || true  # dnf check-update è¿”å›éé›¶å€¼æ˜¯æ­£å¸¸çš„
            ;;
        "brew")
            brew update || log_warn "Homebrew æ›´æ–°å¤±è´¥"
            ;;
        *)
            log_warn "æœªçŸ¥çš„åŒ…ç®¡ç†å™¨ï¼Œè·³è¿‡æ›´æ–°"
            ;;
    esac
}

# è®¾ç½®å·¥å…·è·¯å¾„
setup_tool_paths() {
    log_step "è®¾ç½®å·¥å…·è·¯å¾„..."
    
    # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­
    local local_bin="$HOME/.local/bin"
    if [[ -d "$local_bin" ]] && [[ ":$PATH:" != *":$local_bin:"* ]]; then
        export PATH="$local_bin:$PATH"
        log_info "å·²æ·»åŠ  $local_bin åˆ° PATH"
    fi
    
    # Linux ä¸Šçš„ Homebrew è·¯å¾„è®¾ç½®
    if [[ "$PLATFORM" == "linux" ]] && [[ -d "/home/linuxbrew/.linuxbrew" ]]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        log_info "å·²è®¾ç½® Linux Homebrew ç¯å¢ƒ"
    fi
}

# éªŒè¯å…³é”®å·¥å…·å®‰è£…
verify_installation() {
    log_step "éªŒè¯å·¥å…·å®‰è£…..."
    
    local all_tools=()
    
    # åˆå¹¶æ‰€æœ‰å·¥å…·åˆ—è¡¨
    for tool in "${!ESSENTIAL_TOOLS[@]}"; do
        all_tools+=("$tool")
    done
    
    for tool in "${!MODERN_CLI_TOOLS[@]}"; do
        all_tools+=("$tool")
    done
    
    for tool in "${!DEVELOPMENT_TOOLS[@]}"; do
        all_tools+=("$tool")
    done
    
{{- if .features.enable_node }}
    for tool in "${!NODE_TOOLS[@]}"; do
        all_tools+=("$tool")
    done
{{- end }}

{{- if .features.enable_python }}
    for tool in "${!PYTHON_TOOLS[@]}"; do
        all_tools+=("$tool")
    done
{{- end }}
    
    local installed_count=0
    local total_count=${#all_tools[@]}
    
    echo ""
    echo "å·¥å…·å®‰è£…éªŒè¯æŠ¥å‘Š:"
    echo "===================="
    
    for tool in "${all_tools[@]}"; do
        if check_tool_installed "$tool"; then
            local version=$(get_tool_version "$tool")
            echo "âœ… $tool - $version"
            ((installed_count++))
        else
            echo "âŒ $tool - æœªå®‰è£…"
        fi
    done
    
    echo ""
    echo "å®‰è£…ç»Ÿè®¡: $installed_count/$total_count å·¥å…·å·²å®‰è£…"
    
    if [[ $installed_count -eq $total_count ]]; then
        log_success "ğŸ‰ æ‰€æœ‰å·¥å…·å®‰è£…éªŒè¯é€šè¿‡!"
        return 0
    else
        log_warn "âš ï¸ éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„æŠ¥å‘Š"
        return 1
    fi
}

# æ˜¾ç¤ºå®‰è£…æ‘˜è¦
show_installation_summary() {
    log_step "å®‰è£…æ‘˜è¦"
    
    echo ""
    echo "ç³»ç»Ÿä¿¡æ¯:"
    echo "  - å¹³å°: $PLATFORM ($ARCH)"
    echo "  - ç¯å¢ƒ: $ENVIRONMENT"
    echo "  - åŒ…ç®¡ç†å™¨: $PACKAGE_MANAGER"
    
    echo ""
    echo "åŠŸèƒ½é…ç½®:"
{{- if .features.enable_node }}
    echo "  - Node.js æ”¯æŒ: å¯ç”¨"
{{- end }}
{{- if .features.enable_python }}
    echo "  - Python æ”¯æŒ: å¯ç”¨"
{{- end }}
{{- if .features.enable_ai_tools }}
    echo "  - AI å·¥å…·: å¯ç”¨"
{{- end }}
{{- if .features.enable_proxy }}
    echo "  - ä»£ç†å·¥å…·: å¯ç”¨"
{{- end }}
    
    echo ""
    log_info "è¦æŸ¥çœ‹å·²å®‰è£…çš„å·¥å…·ï¼Œè¿è¡Œ: which <tool_name>"
    log_info "è¦æ›´æ–°å·¥å…·ï¼Œè¯·è¿è¡Œç›¸åº”çš„åŒ…ç®¡ç†å™¨æ›´æ–°å‘½ä»¤"
    
    if command -v brew >/dev/null 2>&1; then
        log_info "Homebrew å·¥å…·æ›´æ–°: brew upgrade"
    fi
    
    if [[ "$PACKAGE_MANAGER" == "apt" ]]; then
        log_info "ç³»ç»Ÿå·¥å…·æ›´æ–°: sudo apt upgrade"
    fi
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹å·¥å…·è‡ªåŠ¨å®‰è£…æµç¨‹..."
    log_info "å¹³å°: $PLATFORM, ç¯å¢ƒ: $ENVIRONMENT, åŒ…ç®¡ç†å™¨: $PACKAGE_MANAGER"
    
    # è®¾ç½®å·¥å…·è·¯å¾„
    setup_tool_paths
    
    # æ›´æ–°åŒ…ç®¡ç†å™¨
    update_system_packages
    
    # å®‰è£…å¿…éœ€å·¥å…· (æœ€é«˜ä¼˜å…ˆçº§)
    install_tool_group ESSENTIAL_TOOLS "å¿…éœ€å·¥å…·" "auto"
    
    # å®‰è£…ç°ä»£åŒ– CLI å·¥å…·
    install_tool_group MODERN_CLI_TOOLS "ç°ä»£åŒ– CLI å·¥å…·" "auto"
    
    # å®‰è£…å¼€å‘å·¥å…·
    install_tool_group DEVELOPMENT_TOOLS "å¼€å‘å·¥å…·" "auto"
    
{{- if .features.enable_node }}
    # å®‰è£… Node.js å·¥å…·
    install_tool_group NODE_TOOLS "Node.js å·¥å…·" "auto"
{{- end }}

{{- if .features.enable_python }}
    # å®‰è£… Python å·¥å…·
    install_tool_group PYTHON_TOOLS "Python å·¥å…·" "auto"
{{- end }}
    
    # éªŒè¯å®‰è£…
    verify_installation
    
    # æ˜¾ç¤ºæ‘˜è¦
    show_installation_summary
    
    log_success "ğŸ‰ å·¥å…·è‡ªåŠ¨å®‰è£…æµç¨‹å®Œæˆ!"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"