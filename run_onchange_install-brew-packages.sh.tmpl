#!/bin/bash
# Homebrew åŒ…å®‰è£…è„šæœ¬
# ä½¿ç”¨ Brewfile å®‰è£…å’Œç®¡ç†å·¥å…·åŒ…
# Requirements: 4.1, 4.2, 8.1

set -euo pipefail

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# æ£€æŸ¥ Homebrew æ˜¯å¦å·²å®‰è£…
check_homebrew() {
    if ! command -v brew >/dev/null 2>&1; then
        log_error "Homebrew æœªå®‰è£…ã€‚è¯·å…ˆè¿è¡Œ Homebrew å®‰è£…è„šæœ¬ã€‚"
        exit 1
    fi
    
    log_info "å‘ç° Homebrew: $(brew --version | head -n1)"
}

# è®¾ç½® Homebrew ç¯å¢ƒ
setup_homebrew_env() {
    # ç¡®ä¿ Homebrew åœ¨ PATH ä¸­
    if [[ "{{ .chezmoi.os }}" == "linux" ]]; then
        if [[ -d "/home/linuxbrew/.linuxbrew" ]]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        fi
    fi
}

# æ›´æ–° Homebrew
update_homebrew() {
    log_step "æ›´æ–° Homebrew..."
    brew update
    log_info "âœ… Homebrew æ›´æ–°å®Œæˆ"
}

# å®‰è£… Brewfile ä¸­çš„åŒ…
install_packages() {
    local brewfile_path="{{ .chezmoi.homeDir }}/Brewfile"
    
    if [[ ! -f "$brewfile_path" ]]; then
        log_error "Brewfile ä¸å­˜åœ¨: $brewfile_path"
        exit 1
    fi
    
    log_step "ä½¿ç”¨ Brewfile å®‰è£…åŒ…..."
    log_info "Brewfile è·¯å¾„: $brewfile_path"
    
    # ä½¿ç”¨ brew bundle å®‰è£…
    if brew bundle --file="$brewfile_path" --verbose; then
        log_info "âœ… åŒ…å®‰è£…å®Œæˆ"
    else
        log_warn "âš ï¸ éƒ¨åˆ†åŒ…å®‰è£…å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„è¾“å‡º"
    fi
}

# æ¸…ç†ä¸éœ€è¦çš„åŒ…
cleanup_packages() {
    log_step "æ¸…ç†ä¸éœ€è¦çš„åŒ…..."
    
    # æ¸…ç†ç¼“å­˜
    brew cleanup
    
    # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
    if brew outdated --quiet | grep -q .; then
        log_info "å‘ç°è¿‡æ—¶çš„åŒ…:"
        brew outdated
        log_info "è¿è¡Œ 'brew upgrade' æ¥æ›´æ–°è¿™äº›åŒ…"
    else
        log_info "æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°çš„"
    fi
}

# éªŒè¯å…³é”®å·¥å…·å®‰è£…
verify_tools() {
    log_step "éªŒè¯å…³é”®å·¥å…·å®‰è£…..."
    
    local tools=(
        "git:Git ç‰ˆæœ¬æ§åˆ¶"
        "curl:HTTP å®¢æˆ·ç«¯"
        "eza:ç°ä»£åŒ– ls"
        "bat:ç°ä»£åŒ– cat"
        "fzf:æ¨¡ç³Šæœç´¢"
        "starship:Shell æç¤ºç¬¦"
    )
    
    local failed_tools=()
    
    for tool_info in "${tools[@]}"; do
        local tool="${tool_info%%:*}"
        local description="${tool_info##*:}"
        
        if command -v "$tool" >/dev/null 2>&1; then
            log_info "âœ… $description ($tool)"
        else
            log_warn "âŒ $description ($tool) - æœªæ‰¾åˆ°"
            failed_tools+=("$tool")
        fi
    done
    
    if [[ ${#failed_tools[@]} -gt 0 ]]; then
        log_warn "ä»¥ä¸‹å·¥å…·å®‰è£…å¤±è´¥: ${failed_tools[*]}"
        log_warn "è¯·æ£€æŸ¥ Brewfile é…ç½®æˆ–æ‰‹åŠ¨å®‰è£…è¿™äº›å·¥å…·"
    else
        log_info "ğŸ‰ æ‰€æœ‰å…³é”®å·¥å…·éªŒè¯é€šè¿‡!"
    fi
}

# æ˜¾ç¤ºå®‰è£…æ‘˜è¦
show_summary() {
    log_step "å®‰è£…æ‘˜è¦"
    
    echo "å·²å®‰è£…çš„ Homebrew åŒ…æ•°é‡:"
    echo "  - Formulae: $(brew list --formula | wc -l)"
    
    {{- if eq .chezmoi.os "darwin" }}
    echo "  - Casks: $(brew list --cask | wc -l)"
    {{- end }}
    
    echo ""
    echo "Homebrew ä¿¡æ¯:"
    echo "  - ç‰ˆæœ¬: $(brew --version | head -n1)"
    echo "  - å‰ç¼€: $(brew --prefix)"
    echo "  - ä»“åº“: $(brew --repository)"
    
    echo ""
    log_info "è¦æŸ¥çœ‹æ‰€æœ‰å·²å®‰è£…çš„åŒ…ï¼Œè¿è¡Œ: brew list"
    log_info "è¦æ›´æ–°åŒ…ï¼Œè¿è¡Œ: brew upgrade"
    log_info "è¦æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œè¿è¡Œ: brew cleanup"
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹ Homebrew åŒ…å®‰è£…æµç¨‹..."
    
    # æ£€æŸ¥ Homebrew
    check_homebrew
    
    # è®¾ç½®ç¯å¢ƒ
    setup_homebrew_env
    
    # æ›´æ–° Homebrew
    update_homebrew
    
    # å®‰è£…åŒ…
    install_packages
    
    # æ¸…ç†
    cleanup_packages
    
    # éªŒè¯å·¥å…·
    verify_tools
    
    # æ˜¾ç¤ºæ‘˜è¦
    show_summary
    
    log_info "ğŸ‰ Homebrew åŒ…å®‰è£…æµç¨‹å®Œæˆ!"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"