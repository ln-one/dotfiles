# ========================================
# Chezmoi Main Configuration (Simplified)
# ----------------------------------------
# - Dynamically generates config based on platform/environment
# - Complex logic is split into separate template files
# ========================================

# ========== Environment Detection ==========
[data]
  # Detect environment type (prefer SSH)
  {{- if or (env "SSH_CONNECTION") (env "SSH_CLIENT") (env "SSH_TTY") }}
    environment = "remote"
  {{- else if and (stat "/proc/version") (regexMatch "microsoft" (cat "/proc/version")) }}
    environment = "wsl"
  {{- else if env "CONTAINER" }}
    environment = "container"
  {{- else }}
    environment = "desktop"
  {{- end }}

  # Use Homebrew as package manager
  package_manager = "brew"

# ========== User Info ==========
[data.user]
  name = "{{ .chezmoi.username }}"
  email = "ln1.opensource@gmail.com"  # User should customize

# ========== Preferences ==========
[data.preferences]
  shell = "zsh"
  editor = "nvim"
  theme = "dark"
  ls_tool = "eza"  # Options: eza, exa, ls

# ========== Features ==========
[data.features]
  {{ includeTemplate "config/features/core-features.toml" . }}
  {{ includeTemplate "config/features/dev-features.toml" . }}
  {{- if eq .chezmoi.os "darwin" }}
    {{ includeTemplate "config/features/macos-features.toml" . }}
  {{- end }}
  {{- if eq .chezmoi.os "linux" }}
    {{ includeTemplate "config/features/linux-features.toml" . }}
  {{- end }}
  {{- if eq .chezmoi.os "windows" }}
    {{ includeTemplate "config/features/windows-features.toml" . }}
  {{- end }}

# ========== Proxy ==========
[data.proxy]
  {{ includeTemplate "config/proxy/proxy-detection.toml" . }}

# ========== Packages ==========
[data.packages]
  # Core tools (Homebrew standard names)
  brew = [
    "git", "curl", "wget", "fzf", "ripgrep", "fd", "bat", "eza", "zoxide"
  ]
  # No apt mapping, managed by Homebrew

  # Essential tools (by priority group)
  essential = ["git", "curl", "wget", "unzip"]
  modern_cli = ["eza", "bat", "fd", "ripgrep", "fzf", "jq", "zoxide"]
  development = ["neovim", "tmux", "htop", "tree"]

# ========== Paths ==========
[data.paths]
  dotfiles = "{{ .chezmoi.sourceDir }}"
  projects = "{{ .chezmoi.homeDir }}/Projects"
  config = "{{ .chezmoi.homeDir }}/.config"

# ========== Environment-specific ==========
{{ includeTemplate "config/environment-packages.toml" . }}

# ========== Chezmoi Behavior ==========
[edit]
  command = "{{ if stat (joinPath (env "HOMEBREW_PREFIX" | default "/opt/homebrew") "bin/code") }}{{ joinPath (env "HOMEBREW_PREFIX" | default "/opt/homebrew") "bin/code" }}{{ else if stat (joinPath (env "HOMEBREW_PREFIX" | default "/opt/homebrew") "bin/nvim") }}{{ joinPath (env "HOMEBREW_PREFIX" | default "/opt/homebrew") "bin/nvim" }}{{ else }}vi{{ end }}"

[git]
  autoCommit = true
  autoPush = false

# ========== Secrets ==========
{{- $op_available := and (or (lookPath "op") (stat (joinPath (env "HOMEBREW_PREFIX" | default "/opt/homebrew") "bin/op")) (stat "/usr/bin/op")) (not (or (env "SSH_CONNECTION") (env "SSH_CLIENT"))) }}
{{- $is_remote := or (env "SSH_CONNECTION") (env "SSH_CLIENT") }}
{{- if and (hasKey . "features") .features.enable_1password $op_available (not $is_remote) }}
  {{ includeTemplate "config/secrets/secrets-1password.toml" . }}
{{- else }}
  {{ includeTemplate "config/secrets/secrets-fallback.toml" . }}
{{- end }}

encryption = ""
