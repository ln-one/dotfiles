#!/bin/bash
# ç‰ˆæœ¬ç®¡ç†å™¨è‡ªåŠ¨å®‰è£…å’Œé…ç½®è„šæœ¬
# å®‰è£…å’Œé…ç½® NVM, pyenv, rbenv ç­‰ç‰ˆæœ¬ç®¡ç†å™¨
# Requirements: 8.3

set -euo pipefail

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

log_success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# å…¨å±€å˜é‡
PLATFORM="{{ .chezmoi.os }}"
ARCH="{{ .chezmoi.arch }}"
HOME_DIR="{{ .chezmoi.homeDir }}"

# ç‰ˆæœ¬ç®¡ç†å™¨é…ç½®
declare -A VERSION_MANAGERS=(
    ["nvm"]="Node.js ç‰ˆæœ¬ç®¡ç†å™¨"
    ["pyenv"]="Python ç‰ˆæœ¬ç®¡ç†å™¨"
    ["rbenv"]="Ruby ç‰ˆæœ¬ç®¡ç†å™¨"
    ["mise"]="é€šç”¨ç‰ˆæœ¬ç®¡ç†å™¨"
)

# æ£€æŸ¥ç‰ˆæœ¬ç®¡ç†å™¨æ˜¯å¦å·²å®‰è£…
check_version_manager_installed() {
    local manager="$1"
    
    case "$manager" in
        "nvm")
            [[ -s "$HOME_DIR/.nvm/nvm.sh" ]] && return 0
            ;;
        "pyenv")
            command -v pyenv >/dev/null 2>&1 && return 0
            ;;
        "rbenv")
            command -v rbenv >/dev/null 2>&1 && return 0
            ;;
        "mise")
            command -v mise >/dev/null 2>&1 && return 0
            ;;
        *)
            return 1
            ;;
    esac
    
    return 1
}

# å®‰è£… NVM (Node Version Manager)
install_nvm() {
    log_step "å®‰è£… NVM (Node Version Manager)..."
    
    if check_version_manager_installed "nvm"; then
        log_success "âœ… NVM å·²å®‰è£…"
        return 0
    fi
    
    # ä¸‹è½½å¹¶å®‰è£… NVM
    local nvm_version="v0.39.7"  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
    local install_script="https://raw.githubusercontent.com/nvm-sh/nvm/${nvm_version}/install.sh"
    
    log_info "ä¸‹è½½ NVM å®‰è£…è„šæœ¬..."
    if curl --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 -o- "$install_script" | bash; then
        log_success "âœ… NVM å®‰è£…æˆåŠŸ"
        
        # é‡æ–°åŠ è½½ shell ç¯å¢ƒ
        export NVM_DIR="$HOME_DIR/.nvm"
        [[ -s "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"
        
        # è·³è¿‡è‡ªåŠ¨å®‰è£… Node.jsï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å®‰è£…
        log_info "NVM å·²å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨ 'nvm install --lts' å®‰è£… Node.js LTS ç‰ˆæœ¬"
        
        return 0
    else
        log_error "âŒ NVM å®‰è£…å¤±è´¥"
        return 1
    fi
}

# å®‰è£… pyenv (Python Version Manager)
install_pyenv() {
    log_step "å®‰è£… pyenv (Python Version Manager)..."
    
    if check_version_manager_installed "pyenv"; then
        log_success "âœ… pyenv å·²å®‰è£…"
        return 0
    fi
    
    # å®‰è£… pyenv ä¾èµ–
    log_info "å®‰è£… pyenv æ„å»ºä¾èµ–..."
    case "$PLATFORM" in
        "linux")
            if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
                    libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \
                    libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
                    libffi-dev liblzma-dev
            elif command -v yum >/dev/null 2>&1; then
                sudo yum groupinstall -y "Development Tools"
                sudo yum install -y gcc openssl-devel bzip2-devel libffi-devel \
                    zlib-devel readline-devel sqlite-devel
            fi
            ;;
        "darwin")
            # macOS é€šå¸¸å·²æœ‰å¿…è¦çš„æ„å»ºå·¥å…·
            log_info "macOS ç¯å¢ƒï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
            ;;
    esac
    
    # ä½¿ç”¨ git ç›´æ¥å®‰è£… pyenv (æ›´å¯é çš„æ–¹æ³•)
    log_info "ä½¿ç”¨ git å…‹éš† pyenv..."
    if git clone https://github.com/pyenv/pyenv.git "$HOME_DIR/.pyenv"; then
        log_success "âœ… pyenv å…‹éš†æˆåŠŸ"
        
        # å…‹éš† pyenv-virtualenv æ’ä»¶
        git clone https://github.com/pyenv/pyenv-virtualenv.git "$HOME_DIR/.pyenv/plugins/pyenv-virtualenv" || true
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PYENV_ROOT="$HOME_DIR/.pyenv"
        export PATH="$PYENV_ROOT/bin:$PATH"
        
        # ç¼–è¯‘ pyenv (å¯é€‰ï¼Œæé«˜æ€§èƒ½)
        cd "$HOME_DIR/.pyenv" && src/configure && make -C src || log_warn "pyenv ç¼–è¯‘å¤±è´¥ï¼Œå°†ä½¿ç”¨è§£é‡Šæ¨¡å¼"
        
        # åˆå§‹åŒ– pyenv
        if command -v pyenv >/dev/null 2>&1; then
            eval "$(pyenv init -)"
            log_success "âœ… pyenv å®‰è£…æˆåŠŸ"
            
            # è·³è¿‡è‡ªåŠ¨å®‰è£… Pythonï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å®‰è£…
            log_info "pyenv å·²å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨ 'pyenv install <version>' å®‰è£… Python ç‰ˆæœ¬"
        fi
        
        return 0
    else
        log_error "âŒ pyenv å®‰è£…å¤±è´¥"
        return 1
    fi
}

# å®‰è£… rbenv (Ruby Version Manager)
install_rbenv() {
    log_step "å®‰è£… rbenv (Ruby Version Manager)..."
    
    if check_version_manager_installed "rbenv"; then
        log_success "âœ… rbenv å·²å®‰è£…"
        return 0
    fi
    
    # ä½¿ç”¨ Homebrew æˆ– git å®‰è£… rbenv
    if command -v brew >/dev/null 2>&1; then
        log_info "ä½¿ç”¨ Homebrew å®‰è£… rbenv..."
        brew install rbenv ruby-build
    else
        log_info "ä½¿ç”¨ git å®‰è£… rbenv..."
        git clone https://github.com/rbenv/rbenv.git "$HOME_DIR/.rbenv"
        git clone https://github.com/rbenv/ruby-build.git "$HOME_DIR/.rbenv/plugins/ruby-build"
        
        # ç¼–è¯‘åŠ¨æ€æ‰©å±•
        cd "$HOME_DIR/.rbenv" && src/configure && make -C src
    fi
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    export PATH="$HOME_DIR/.rbenv/bin:$PATH"
    
    if command -v rbenv >/dev/null 2>&1; then
        eval "$(rbenv init -)"
        log_success "âœ… rbenv å®‰è£…æˆåŠŸ"
        
        # å®‰è£…æœ€æ–°çš„ Ruby ç¨³å®šç‰ˆ
        log_info "å®‰è£… Ruby æœ€æ–°ç¨³å®šç‰ˆ..."
        local ruby_version=$(rbenv install -l | grep -E '^\s*3\.[0-9]+\.[0-9]+$' | tail -1 | tr -d ' ')
        if [[ -n "$ruby_version" ]]; then
            rbenv install "$ruby_version"
            rbenv global "$ruby_version"
            log_success "âœ… Ruby $ruby_version å®‰è£…å®Œæˆ"
        fi
        
        return 0
    else
        log_error "âŒ rbenv å®‰è£…å¤±è´¥"
        return 1
    fi
}

# å®‰è£… mise (é€šç”¨ç‰ˆæœ¬ç®¡ç†å™¨)
install_mise() {
    log_step "å®‰è£… mise (é€šç”¨ç‰ˆæœ¬ç®¡ç†å™¨)..."
    
    if check_version_manager_installed "mise"; then
        log_success "âœ… mise å·²å®‰è£…"
        return 0
    fi
    
    # ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬
    log_info "ä¸‹è½½ mise å®‰è£…è„šæœ¬..."
    if curl --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 https://mise.run | sh; then
        log_success "âœ… mise å®‰è£…æˆåŠŸ"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PATH="$HOME_DIR/.local/bin:$PATH"
        
        if command -v mise >/dev/null 2>&1; then
            # æ¿€æ´» mise
            eval "$(mise activate bash)"
            log_info "mise å·²æ¿€æ´»"
        fi
        
        return 0
    else
        log_error "âŒ mise å®‰è£…å¤±è´¥"
        return 1
    fi
}

# åˆ›å»ºç‰ˆæœ¬ç®¡ç†å™¨é…ç½®æ–‡ä»¶
create_version_manager_configs() {
    log_step "åˆ›å»ºç‰ˆæœ¬ç®¡ç†å™¨é…ç½®æ–‡ä»¶..."
    
    # åˆ›å»º .nvmrc æ–‡ä»¶
    if check_version_manager_installed "nvm"; then
        echo "lts/*" > "$HOME_DIR/.nvmrc"
        log_info "å·²åˆ›å»º .nvmrc é…ç½®æ–‡ä»¶"
    fi

    # åˆ›å»º .python-version æ–‡ä»¶
    if check_version_manager_installed "pyenv"; then
        local python_version=$(pyenv global 2>/dev/null || echo "3.12.0")
        echo "$python_version" > "$HOME_DIR/.python-version"
        log_info "å·²åˆ›å»º .python-version é…ç½®æ–‡ä»¶"
    fi

    # åˆ›å»º .ruby-version æ–‡ä»¶ (å¦‚æœå®‰è£…äº† rbenv)
    if check_version_manager_installed "rbenv"; then
        local ruby_version=$(rbenv global 2>/dev/null || echo "3.3.0")
        echo "$ruby_version" > "$HOME_DIR/.ruby-version"
        log_info "å·²åˆ›å»º .ruby-version é…ç½®æ–‡ä»¶"
    fi

    # åˆ›å»º .mise.toml é…ç½®æ–‡ä»¶ (å¦‚æœå®‰è£…äº† mise)
    if check_version_manager_installed "mise"; then
        cat > "$HOME_DIR/.mise.toml" << 'EOF'
[tools]
# åœ¨è¿™é‡Œå®šä¹‰å…¨å±€å·¥å…·ç‰ˆæœ¬
# ä¾‹å¦‚: node = "lts"
#      python = "3.12"
#      ruby = "3.3"

[settings]
# mise è®¾ç½®
experimental = true
EOF
        log_info "å·²åˆ›å»º .mise.toml é…ç½®æ–‡ä»¶"
    fi
}

# éªŒè¯ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…
verify_version_managers() {
    log_step "éªŒè¯ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…..."
    
    local installed_count=0
    local total_count=${#VERSION_MANAGERS[@]}
    
    echo ""
    echo "ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…éªŒè¯æŠ¥å‘Š:"
    echo "========================"
    
    for manager in "${!VERSION_MANAGERS[@]}"; do
        local description="${VERSION_MANAGERS[$manager]}"
        
        if check_version_manager_installed "$manager"; then
            echo "âœ… $manager - $description"
            installed_count=$((installed_count + 1))
            
            # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
            case "$manager" in
                "nvm")
                    if command -v nvm >/dev/null 2>&1; then
                        local nvm_version=$(nvm --version 2>/dev/null || echo "æœªçŸ¥")
                        echo "   ç‰ˆæœ¬: $nvm_version"
                        local node_version=$(node --version 2>/dev/null || echo "æœªå®‰è£…")
                        echo "   å½“å‰ Node.js: $node_version"
                    fi
                    ;;
                "pyenv")
                    if command -v pyenv >/dev/null 2>&1; then
                        local pyenv_version=$(pyenv --version 2>/dev/null || echo "æœªçŸ¥")
                        echo "   ç‰ˆæœ¬: $pyenv_version"
                        local python_version=$(python --version 2>/dev/null || echo "æœªå®‰è£…")
                        echo "   å½“å‰ Python: $python_version"
                    fi
                    ;;
                "rbenv")
                    if command -v rbenv >/dev/null 2>&1; then
                        local rbenv_version=$(rbenv --version 2>/dev/null || echo "æœªçŸ¥")
                        echo "   ç‰ˆæœ¬: $rbenv_version"
                        local ruby_version=$(ruby --version 2>/dev/null || echo "æœªå®‰è£…")
                        echo "   å½“å‰ Ruby: $ruby_version"
                    fi
                    ;;
                "mise")
                    if command -v mise >/dev/null 2>&1; then
                        local mise_version=$(mise --version 2>/dev/null || echo "æœªçŸ¥")
                        echo "   ç‰ˆæœ¬: $mise_version"
                    fi
                    ;;
            esac
        else
            echo "âŒ $manager - $description (æœªå®‰è£…)"
        fi
    done
    
    echo ""
    echo "å®‰è£…ç»Ÿè®¡: $installed_count/$total_count ç‰ˆæœ¬ç®¡ç†å™¨å·²å®‰è£…"
    
    if [[ $installed_count -gt 0 ]]; then
        log_success "ğŸ‰ ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…éªŒè¯å®Œæˆ!"
        return 0
    else
        log_warn "âš ï¸ æ²¡æœ‰ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…æˆåŠŸ"
        return 1
    fi
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage_instructions() {
    log_step "ç‰ˆæœ¬ç®¡ç†å™¨ä½¿ç”¨è¯´æ˜"
    
    echo ""
    echo "ç‰ˆæœ¬ç®¡ç†å™¨ä½¿ç”¨æŒ‡å—:"
    echo "=================="
    
    if check_version_manager_installed "nvm"; then
        echo ""
        echo "NVM (Node.js):"
        echo "  - å®‰è£… Node.js ç‰ˆæœ¬: nvm install <version>"
        echo "  - åˆ‡æ¢ç‰ˆæœ¬: nvm use <version>"
        echo "  - åˆ—å‡ºå¯ç”¨ç‰ˆæœ¬: nvm list-remote"
        echo "  - è®¾ç½®é»˜è®¤ç‰ˆæœ¬: nvm alias default <version>"
    fi

    if check_version_manager_installed "pyenv"; then
        echo ""
        echo "pyenv (Python):"
        echo "  - å®‰è£… Python ç‰ˆæœ¬: pyenv install <version>"
        echo "  - åˆ‡æ¢å…¨å±€ç‰ˆæœ¬: pyenv global <version>"
        echo "  - åˆ‡æ¢æœ¬åœ°ç‰ˆæœ¬: pyenv local <version>"
        echo "  - åˆ—å‡ºå¯ç”¨ç‰ˆæœ¬: pyenv install --list"
    fi

    if check_version_manager_installed "rbenv"; then
        echo ""
        echo "rbenv (Ruby):"
        echo "  - å®‰è£… Ruby ç‰ˆæœ¬: rbenv install <version>"
        echo "  - åˆ‡æ¢å…¨å±€ç‰ˆæœ¬: rbenv global <version>"
        echo "  - åˆ‡æ¢æœ¬åœ°ç‰ˆæœ¬: rbenv local <version>"
        echo "  - åˆ—å‡ºå¯ç”¨ç‰ˆæœ¬: rbenv install --list"
    fi

    if check_version_manager_installed "mise"; then
        echo ""
        echo "mise (é€šç”¨):"
        echo "  - å®‰è£…å·¥å…·: mise install <tool>@<version>"
        echo "  - ä½¿ç”¨å·¥å…·: mise use <tool>@<version>"
        echo "  - åˆ—å‡ºå·¥å…·: mise list"
        echo "  - é…ç½®æ–‡ä»¶: ~/.mise.toml"
    fi
    
    echo ""
    log_info "é‡æ–°å¯åŠ¨ shell æˆ–è¿è¡Œ 'source ~/.zshrc' æ¥åŠ è½½ç‰ˆæœ¬ç®¡ç†å™¨"
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…æµç¨‹..."
    log_info "å¹³å°: $PLATFORM ($ARCH)"
    
    local failed_installations=0
    
    # å®‰è£…å„ä¸ªç‰ˆæœ¬ç®¡ç†å™¨ (æ ¹æ®éœ€è¦å¯ç”¨/ç¦ç”¨)
    install_nvm || failed_installations=$((failed_installations + 1))
    install_pyenv || failed_installations=$((failed_installations + 1))
    # install_rbenv || failed_installations=$((failed_installations + 1))  # å¯é€‰
    # install_mise || failed_installations=$((failed_installations + 1))   # å¯é€‰
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    create_version_manager_configs
    
    # éªŒè¯å®‰è£…
    verify_version_managers
    
    # æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
    show_usage_instructions
    
    if [[ $failed_installations -eq 0 ]]; then
        log_success "ğŸ‰ ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…æµç¨‹å®Œæˆ!"
    else
        log_warn "âš ï¸ éƒ¨åˆ†ç‰ˆæœ¬ç®¡ç†å™¨å®‰è£…å¤±è´¥ ($failed_installations ä¸ª)"
    fi
    
    log_info "è¯·é‡æ–°å¯åŠ¨ç»ˆç«¯æˆ–è¿è¡Œ 'source ~/.zshrc' æ¥æ¿€æ´»ç‰ˆæœ¬ç®¡ç†å™¨"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"