#!/bin/bash
# ========================================
# fzf æ¨¡ç³Šæœç´¢å®‰è£…è„šæœ¬ (Chezmoi ç®¡ç†)
# ========================================
# å®‰è£…å’Œé…ç½® fzf æ¨¡ç³Šæœç´¢å·¥å…·

{{- if .features.enable_fzf }}

set -euo pipefail

echo "ğŸ” å¼€å§‹å®‰è£… fzf æ¨¡ç³Šæœç´¢å·¥å…·..."

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if command -v fzf >/dev/null 2>&1; then
    echo "âœ… fzf å·²å®‰è£…ï¼Œç‰ˆæœ¬: $(fzf --version)"
    # æ£€æŸ¥ shell é›†æˆæ˜¯å¦å·²é…ç½®
    if [ -f ~/.fzf.zsh ] || [ -f ~/.fzf.bash ]; then
        echo "âœ… fzf shell é›†æˆå·²é…ç½®"
        exit 0
    else
        echo "ğŸ”§ é…ç½® fzf shell é›†æˆ..."
        # å¦‚æœ fzf å·²å®‰è£…ä½†æ²¡æœ‰ shell é›†æˆï¼Œåªå®‰è£…é›†æˆéƒ¨åˆ†
        if [ ! -d ~/.fzf ]; then
            git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        fi
        ~/.fzf/install --all --no-update-rc
        echo "âœ… fzf shell é›†æˆé…ç½®å®Œæˆ"
        exit 0
    fi
fi

# æ ¹æ®å¹³å°å’ŒåŒ…ç®¡ç†å™¨å®‰è£…
{{- if eq .chezmoi.os "darwin" }}
# macOS: ä¼˜å…ˆä½¿ç”¨ Homebrew
if command -v brew >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ Homebrew å®‰è£… fzf..."
    brew install fzf
    
    # å®‰è£… shell é›†æˆ
    echo "ğŸ”§ é…ç½® fzf shell é›†æˆ..."
    $(brew --prefix)/opt/fzf/install --all --no-update-rc
else
    echo "ğŸ“¥ ä½¿ç”¨ Git å®‰è£… fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all --no-update-rc
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: æ£€æŸ¥åŒ…ç®¡ç†å™¨
if command -v brew >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ Homebrew å®‰è£… fzf..."
    brew install fzf
    
    # å®‰è£… shell é›†æˆ
    echo "ğŸ”§ é…ç½® fzf shell é›†æˆ..."
    $(brew --prefix)/opt/fzf/install --all --no-update-rc
    
elif command -v apt >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ apt å®‰è£… fzf..."
    sudo apt update && sudo apt install -y fzf
    
    # Ubuntu/Debian çš„ fzf åŒ…é€šå¸¸ä¸åŒ…å« shell é›†æˆï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…
    if [ ! -f ~/.fzf.zsh ] && [ ! -f ~/.fzf.bash ]; then
        echo "ğŸ”§ æ‰‹åŠ¨é…ç½® fzf shell é›†æˆ..."
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --all --no-update-rc
    fi
    
else
    echo "ğŸ“¥ ä½¿ç”¨ Git å®‰è£… fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all --no-update-rc
fi
{{- end }}

# éªŒè¯å®‰è£…
if command -v fzf >/dev/null 2>&1; then
    echo "âœ… fzf å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: $(fzf --version)"
    
    # æ£€æŸ¥ shell é›†æˆæ–‡ä»¶
    if [ -f ~/.fzf.zsh ]; then
        echo "âœ… fzf zsh é›†æˆå·²é…ç½®"
    fi
    if [ -f ~/.fzf.bash ]; then
        echo "âœ… fzf bash é›†æˆå·²é…ç½®"
    fi
    
    echo "ğŸ‰ fzf é…ç½®å®Œæˆï¼é‡æ–°å¯åŠ¨ç»ˆç«¯æ¥åº”ç”¨æ›´æ”¹"
else
    echo "âŒ fzf å®‰è£…å¤±è´¥"
    exit 1
fi

{{- else }}
echo "â„¹ï¸  fzf åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡å®‰è£…"
{{- end }}