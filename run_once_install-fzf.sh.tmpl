#!/bin/bash
# ========================================
# fzf 模糊搜索安装脚本 (Chezmoi 管理)
# ========================================
# 安装和配置 fzf 模糊搜索工具

{{- if .features.enable_fzf }}

set -euo pipefail

echo "🔍 开始安装 fzf 模糊搜索工具..."

# 检查是否已安装
if command -v fzf >/dev/null 2>&1; then
    echo "✅ fzf 已安装，版本: $(fzf --version)"
    # 检查 shell 集成是否已配置
    if [ -f ~/.fzf.zsh ] || [ -f ~/.fzf.bash ]; then
        echo "✅ fzf shell 集成已配置"
        exit 0
    else
        echo "🔧 配置 fzf shell 集成..."
        # 如果 fzf 已安装但没有 shell 集成，只安装集成部分
        if [ ! -d ~/.fzf ]; then
            git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        fi
        ~/.fzf/install --all --no-update-rc
        echo "✅ fzf shell 集成配置完成"
        exit 0
    fi
fi

# 根据平台和包管理器安装
{{- if eq .chezmoi.os "darwin" }}
# macOS: 优先使用 Homebrew
if command -v brew >/dev/null 2>&1; then
    echo "📦 使用 Homebrew 安装 fzf..."
    brew install fzf
    
    # 安装 shell 集成
    echo "🔧 配置 fzf shell 集成..."
    $(brew --prefix)/opt/fzf/install --all --no-update-rc
else
    echo "📥 使用 Git 安装 fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all --no-update-rc
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: 检查包管理器
if command -v brew >/dev/null 2>&1; then
    echo "📦 使用 Homebrew 安装 fzf..."
    brew install fzf
    
    # 安装 shell 集成
    echo "🔧 配置 fzf shell 集成..."
    $(brew --prefix)/opt/fzf/install --all --no-update-rc
    
elif command -v apt >/dev/null 2>&1; then
    echo "📦 使用 apt 安装 fzf..."
    sudo apt update && sudo apt install -y fzf
    
    # Ubuntu/Debian 的 fzf 包通常不包含 shell 集成，需要手动安装
    if [ ! -f ~/.fzf.zsh ] && [ ! -f ~/.fzf.bash ]; then
        echo "🔧 手动配置 fzf shell 集成..."
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --all --no-update-rc
    fi
    
else
    echo "📥 使用 Git 安装 fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all --no-update-rc
fi
{{- end }}

# 验证安装
if command -v fzf >/dev/null 2>&1; then
    echo "✅ fzf 安装成功，版本: $(fzf --version)"
    
    # 检查 shell 集成文件
    if [ -f ~/.fzf.zsh ]; then
        echo "✅ fzf zsh 集成已配置"
    fi
    if [ -f ~/.fzf.bash ]; then
        echo "✅ fzf bash 集成已配置"
    fi
    
    echo "🎉 fzf 配置完成！重新启动终端来应用更改"
else
    echo "❌ fzf 安装失败"
    exit 1
fi

{{- else }}
echo "ℹ️  fzf 功能已禁用，跳过安装"
{{- end }}