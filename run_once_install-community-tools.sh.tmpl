#!/bin/bash
# ========================================
# ç¤¾åŒºå·¥å…·ç»Ÿä¸€å®‰è£…è„šæœ¬ (Chezmoi ç®¡ç†)
# ========================================
# åè°ƒå®‰è£…æ‰€æœ‰å¯ç”¨çš„ç¤¾åŒºå·¥å…·

set -euo pipefail

echo "ğŸš€ å¼€å§‹å®‰è£…ç¤¾åŒºå·¥å…·é›†æˆ..."

# æ£€æŸ¥åŸºç¡€ä¾èµ–
echo "ğŸ” æ£€æŸ¥åŸºç¡€ä¾èµ–..."
missing_deps=()

if ! command -v curl >/dev/null 2>&1; then
    missing_deps+=("curl")
fi

if ! command -v git >/dev/null 2>&1; then
    missing_deps+=("git")
fi

if [ ${#missing_deps[@]} -gt 0 ]; then
    echo "âŒ ç¼ºå°‘å¿…éœ€ä¾èµ–: ${missing_deps[*]}"
    echo "è¯·å…ˆå®‰è£…è¿™äº›å·¥å…·åé‡è¯•"
    exit 1
fi

# å®‰è£…è®¡æ•°å™¨
installed_count=0
total_tools=0

{{- if and (hasKey . "features") .features.enable_fzf }}
total_tools=$((total_tools + 1))
{{- end }}
{{- if and (hasKey . "features") .features.enable_oh_my_zsh }}
total_tools=$((total_tools + 1))
{{- end }}
{{- if and (hasKey . "features") .features.enable_starship }}
total_tools=$((total_tools + 1))
{{- end }}

echo "ğŸ“‹ è®¡åˆ’å®‰è£… $total_tools ä¸ªç¤¾åŒºå·¥å…·"

# å®‰è£… fzf (ä¼˜å…ˆå®‰è£…ï¼Œå…¶ä»–å·¥å…·å¯èƒ½ä¾èµ–å®ƒ)
{{- if and (hasKey . "features") .features.enable_fzf }}
echo ""
echo "ğŸ“¦ [1/$total_tools] å®‰è£… fzf æ¨¡ç³Šæœç´¢..."
# ç›´æ¥è¿è¡Œ fzf å®‰è£…é€»è¾‘ï¼Œè€Œä¸æ˜¯è°ƒç”¨å¤–éƒ¨è„šæœ¬
if command -v fzf >/dev/null 2>&1; then
    echo "âœ… fzf å·²å®‰è£…ï¼Œç‰ˆæœ¬: $(fzf --version)"
    installed_count=$((installed_count + 1))
else
    echo "ğŸ“¦ å¼€å§‹å®‰è£… fzf..."
    if command -v brew >/dev/null 2>&1; then
        brew install fzf && installed_count=$((installed_count + 1))
    elif command -v apt >/dev/null 2>&1; then
        sudo apt update && sudo apt install -y fzf && installed_count=$((installed_count + 1))
    else
        echo "âŒ æ— æ³•æ‰¾åˆ°åˆé€‚çš„åŒ…ç®¡ç†å™¨å®‰è£… fzf"
    fi
fi
{{- end }}

# å®‰è£… Oh My Zsh
{{- if and (hasKey . "features") .features.enable_oh_my_zsh }}
echo ""
echo "ğŸ“¦ [2/$total_tools] å®‰è£… Oh My Zsh..."
if [ -d "$HOME/.oh-my-zsh" ]; then
    echo "âœ… Oh My Zsh å·²å®‰è£…"
    installed_count=$((installed_count + 1))
else
    echo "ğŸ“¦ å¼€å§‹å®‰è£… Oh My Zsh..."
    if RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"; then
        echo "âœ… Oh My Zsh å®‰è£…æˆåŠŸ"
        installed_count=$((installed_count + 1))
        
        # å®‰è£…æ’ä»¶
        if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions" ]; then
            git clone https://github.com/zsh-users/zsh-autosuggestions.git "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        fi
        if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" ]; then
            git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        fi
    else
        echo "âŒ Oh My Zsh å®‰è£…å¤±è´¥"
    fi
fi
{{- end }}

# å®‰è£… Starship
{{- if and (hasKey . "features") .features.enable_starship }}
echo ""
echo "ğŸ“¦ [3/$total_tools] å®‰è£… Starship æç¤ºç¬¦..."
if command -v starship >/dev/null 2>&1; then
    echo "âœ… Starship å·²å®‰è£…ï¼Œç‰ˆæœ¬: $(starship --version)"
    installed_count=$((installed_count + 1))
else
    echo "ğŸ“¦ å¼€å§‹å®‰è£… Starship..."
    if command -v brew >/dev/null 2>&1; then
        brew install starship && installed_count=$((installed_count + 1))
    else
        curl -sS https://starship.rs/install.sh | sh -s -- --yes && installed_count=$((installed_count + 1))
    fi
fi
{{- end }}

# å®‰è£…æ€»ç»“
echo ""
echo "=========================================="
echo "ğŸ‰ ç¤¾åŒºå·¥å…·å®‰è£…å®Œæˆï¼"
echo "æˆåŠŸå®‰è£…: $installed_count/$total_tools ä¸ªå·¥å…·"

if [ $installed_count -eq $total_tools ]; then
    echo "âœ… æ‰€æœ‰å·¥å…·å®‰è£…æˆåŠŸ"
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:"
    echo "1. é‡æ–°å¯åŠ¨ç»ˆç«¯æˆ–è¿è¡Œ 'source ~/.zshrc'"
    echo "2. è¿è¡Œ 'chezmoi apply' åº”ç”¨æœ€æ–°é…ç½®"
    echo "3. äº«å—ç°ä»£åŒ–çš„ Shell ä½“éªŒï¼"
    
    # æ˜¾ç¤ºå·²å®‰è£…å·¥å…·çš„å¿«é€Ÿä½¿ç”¨æç¤º
    echo ""
    echo "ğŸ”§ å¿«é€Ÿä½¿ç”¨æŒ‡å—:"
    {{- if and (hasKey . "features") .features.enable_fzf }}
    echo "â€¢ fzf: Ctrl+T (æ–‡ä»¶æœç´¢), Ctrl+R (å†å²æœç´¢), Alt+C (ç›®å½•æœç´¢)"
    {{- end }}
    {{- if and (hasKey . "features") .features.enable_oh_my_zsh }}
    echo "â€¢ Oh My Zsh: è¾“å…¥ 'omz' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
    {{- end }}
    {{- if and (hasKey . "features") .features.enable_starship }}
    echo "â€¢ Starship: è‡ªåŠ¨æ˜¾ç¤º Git çŠ¶æ€å’Œé¡¹ç›®ä¿¡æ¯"
    {{- end }}
    
else
    echo "âš ï¸  éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯"
    echo "å¯ä»¥ç¨åæ‰‹åŠ¨é‡æ–°è¿è¡Œå®‰è£…è„šæœ¬"
fi

echo "=========================================="