# ========================================
# SSH Configuration
# ========================================

# Personal server Aliyun (1Password keys)
Host aliyun  
    HostName "{{ .secrets.aliyun_server_url }}"
    User "{{ .secrets.aliyun_server_username }}"
{{- if .features.enable_1password }}
{{- if eq .chezmoi.os "windows" }}
    # Let SSH use the default agent (1Password manages this automatically)
    # IdentityAgent \\.\pipe\1password-ssh-agent
{{- else if eq .chezmoi.os "darwin" }}
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else }}
    IdentityAgent ~/.1password/agent.sock
{{- end }}
{{- end }}
# GitHub (1Password keys)
Host github.com
    HostName ssh.github.com
    User git
    Port 443
{{- if .features.enable_1password }}
{{- if eq .chezmoi.os "windows" }}
    # Let SSH use the default agent (1Password manages this automatically)
    # IdentityAgent \\.\pipe\1password-ssh-agent
{{- else if eq .chezmoi.os "darwin" }}
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else }}
    IdentityAgent ~/.1password/agent.sock
{{- end }}
{{- end }}
{{- if and .features.enable_proxy .proxy.enabled }}
    {{- if hasKey .proxy "socks_port" }}
    ProxyCommand nc -X 5 -x {{ .proxy.host }}:{{ .proxy.socks_port }} %h %p
    {{- end }}
{{- end }}

# YubiKey-only hosts
Host secure-server yubikey-*
{{- if eq .chezmoi.os "windows" }}
    IdentityAgent \\.\pipe\openssh-ssh-agent
{{- else }}
    IdentityAgent $SSH_AUTH_SOCK  # Will point to YubiKey agent dynamically
{{- end }}

# Default for all other hosts
{{- if .features.enable_1password }}
Host *
{{- if eq .chezmoi.os "windows" }}
    # Let SSH use the default agent (1Password manages this automatically)
    # IdentityAgent \\.\pipe\1password-ssh-agent
{{- else if eq .chezmoi.os "darwin" }}
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
    AddKeysToAgent yes
    UseKeychain yes
{{- else }}
    IdentityAgent ~/.1password/agent.sock
{{- end }}
{{- else if eq .chezmoi.os "darwin" }}
Host *
    AddKeysToAgent yes
    UseKeychain yes
{{- end }}