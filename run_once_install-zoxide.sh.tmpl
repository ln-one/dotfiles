#!/bin/bash
# ========================================
# Zoxide 智能目录跳转工具安装脚本
# ========================================
# 自动安装 zoxide - 比传统 z 更快更智能的目录跳转工具
# 目标平台: {{ .chezmoi.os }}/{{ .chezmoi.arch }}
# ========================================

set -e

echo "🚀 开始安装 zoxide..."

{{- if eq .chezmoi.os "darwin" }}
# macOS 使用 Homebrew 安装
if command -v brew >/dev/null 2>&1; then
    echo "📦 使用 Homebrew 安装 zoxide..."
    brew install zoxide
else
    echo "❌ 未找到 Homebrew，请先安装 Homebrew"
    exit 1
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux 系统安装
# 首先检查是否已经安装
if command -v zoxide >/dev/null 2>&1; then
    echo "✅ zoxide 已经安装，跳过安装步骤"
elif command -v curl >/dev/null 2>&1; then
    echo "📦 使用官方安装脚本安装 zoxide..."
    # 添加超时和错误处理
    if timeout 60 curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash; then
        echo "✅ 安装脚本执行完成"
    else
        echo "⚠️  安装脚本超时或失败，尝试手动安装..."
        # 备用安装方法：直接下载二进制文件
        mkdir -p "$HOME/.local/bin"
        curl -sS -L "https://github.com/ajeetdsouza/zoxide/releases/latest/download/zoxide-x86_64-unknown-linux-musl.tar.gz" | tar -xz -C "$HOME/.local/bin"
    fi
    
    # 确保二进制文件在 PATH 中
    if [ -f "$HOME/.local/bin/zoxide" ]; then
        echo "✅ zoxide 已安装到 ~/.local/bin/"
        echo "💡 请确保 ~/.local/bin 在你的 PATH 中"
    fi
else
    echo "❌ 需要 curl 来安装 zoxide"
    exit 1
fi

{{- else }}
echo "⚠️  不支持的操作系统: {{ .chezmoi.os }}"
echo "请手动安装 zoxide: https://github.com/ajeetdsouza/zoxide#installation"
exit 1
{{- end }}

# 验证安装
if command -v zoxide >/dev/null 2>&1; then
    echo "✅ zoxide 安装成功！"
    echo "📍 版本信息:"
    zoxide --version
    echo ""
    echo "🎯 使用方法:"
    echo "  z <目录名>     - 跳转到匹配的目录"
    echo "  zi             - 交互式选择目录"
    echo "  z -            - 返回上一个目录"
    echo "  zoxide query   - 查询数据库"
    echo ""
    echo "💡 提示: 使用几次目录后，zoxide 会学习你的使用习惯"
else
    echo "❌ zoxide 安装失败，请检查错误信息"
    exit 1
fi

echo "🎉 zoxide 安装完成！重新启动 shell 或运行 'source ~/.zshrc' 来使用"