#!/bin/bash
# 1Password SSH Agent 设置脚本
# 由 Chezmoi 管理，仅在启用 1Password 功能时运行

{{- if and (hasKey . "features") .features.enable_1password }}

set -euo pipefail

echo "🔐 设置 1Password SSH Agent 集成..."

# 检查 1Password CLI 是否已安装
if ! command -v op >/dev/null 2>&1; then
    echo "⚠️  1Password CLI 未安装，跳过 SSH Agent 设置"
    echo "   请先安装 1Password CLI: https://developer.1password.com/docs/cli/get-started/"
    exit 0
fi

# 平台特定的 SSH Agent 套接字路径
{{- if eq .chezmoi.os "darwin" }}
SSH_AGENT_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else if eq .chezmoi.os "linux" }}
SSH_AGENT_SOCK="$HOME/.1password/agent.sock"
{{- end }}

# 检查 1Password SSH Agent 是否可用
if [[ -S "$SSH_AGENT_SOCK" ]]; then
    echo "✅ 1Password SSH Agent 套接字已存在: $SSH_AGENT_SOCK"
    
    # 测试 SSH Agent 连接
    if SSH_AUTH_SOCK="$SSH_AGENT_SOCK" ssh-add -l >/dev/null 2>&1; then
        echo "✅ 1Password SSH Agent 连接测试成功"
    else
        echo "⚠️  1Password SSH Agent 连接测试失败"
        echo "   请确保 1Password 应用已启动并启用了 SSH Agent 功能"
    fi
else
    echo "⚠️  1Password SSH Agent 套接字不存在: $SSH_AGENT_SOCK"
    echo "   请在 1Password 应用中启用 SSH Agent 功能:"
    {{- if eq .chezmoi.os "darwin" }}
    echo "   1Password → Settings → Developer → Use the SSH agent"
    {{- else if eq .chezmoi.os "linux" }}
    echo "   1Password → Settings → Security → SSH Agent"
    {{- end }}
fi

# 创建 SSH 配置目录 (如果不存在)
SSH_CONFIG_DIR="$HOME/.ssh"
if [[ ! -d "$SSH_CONFIG_DIR" ]]; then
    mkdir -p "$SSH_CONFIG_DIR"
    chmod 700 "$SSH_CONFIG_DIR"
    echo "✅ 创建 SSH 配置目录: $SSH_CONFIG_DIR"
fi

# 检查 SSH 配置文件中是否已有 1Password 配置
SSH_CONFIG_FILE="$SSH_CONFIG_DIR/config"
if [[ -f "$SSH_CONFIG_FILE" ]]; then
    if grep -q "IdentityAgent" "$SSH_CONFIG_FILE"; then
        echo "✅ SSH 配置文件中已包含 IdentityAgent 配置"
    else
        echo "ℹ️  建议在 SSH 配置文件中添加以下配置:"
        echo "   Host *"
        echo "     IdentityAgent \"$SSH_AGENT_SOCK\""
    fi
else
    echo "ℹ️  SSH 配置文件不存在，可以创建包含以下内容的 ~/.ssh/config:"
    echo "   Host *"
    echo "     IdentityAgent \"$SSH_AGENT_SOCK\""
fi

# 设置环境变量验证
echo "🔍 验证环境变量设置..."
if [[ "${SSH_AUTH_SOCK:-}" == "$SSH_AGENT_SOCK" ]]; then
    echo "✅ SSH_AUTH_SOCK 环境变量已正确设置"
else
    echo "⚠️  SSH_AUTH_SOCK 环境变量未设置或不正确"
    echo "   当前值: ${SSH_AUTH_SOCK:-未设置}"
    echo "   期望值: $SSH_AGENT_SOCK"
    echo "   请重新加载 shell 配置或重启终端"
fi

echo "🔐 1Password SSH Agent 设置完成"
echo ""
echo "📝 使用说明:"
echo "   1. 确保 1Password 应用已启动并登录"
echo "   2. 在 1Password 中启用 SSH Agent 功能"
echo "   3. 将 SSH 密钥添加到 1Password 中"
echo "   4. 重新加载 shell 配置: source ~/.zshrc 或 source ~/.bashrc"
echo "   5. 测试 SSH 连接: ssh-add -l"

{{- else }}
echo "ℹ️  1Password 功能未启用，跳过 SSH Agent 设置"
echo "   要启用，请在 .chezmoi.toml 中设置 features.enable_1password = true"
{{- end }}