#!/bin/bash
# Homebrew Installation Script for Chezmoi
# This script installs Homebrew on both Linux and macOS platforms
# Requirements: 4.1, 4.2, 8.1

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if Homebrew is already installed
check_homebrew_installed() {
    if command -v brew >/dev/null 2>&1; then
        log_info "Homebrew is already installed at $(which brew)"
        log_info "Homebrew version: $(brew --version | head -n1)"
        return 0
    else
        return 1
    fi
}

# Install Homebrew based on platform
install_homebrew() {
    local platform="{{ .chezmoi.os }}"
    
    log_info "Installing Homebrew for platform: $platform"
    
    case "$platform" in
        "darwin")
            log_info "Installing Homebrew for macOS..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            ;;
        "linux")
            log_info "Installing Homebrew for Linux..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add Homebrew to PATH for Linux
            if [[ -d "/home/linuxbrew/.linuxbrew" ]]; then
                echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
                echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc
                eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            fi
            ;;
        *)
            log_error "Unsupported platform: $platform"
            exit 1
            ;;
    esac
}

# Verify Homebrew installation
verify_homebrew() {
    if command -v brew >/dev/null 2>&1; then
        log_info "✅ Homebrew installation verified"
        log_info "Homebrew prefix: $(brew --prefix)"
        
        # Update Homebrew
        log_info "Updating Homebrew..."
        brew update
        
        return 0
    else
        log_error "❌ Homebrew installation failed"
        return 1
    fi
}

# Install build dependencies for Linux
install_linux_dependencies() {
    if [[ "{{ .chezmoi.os }}" == "linux" ]]; then
        log_info "Installing build dependencies for Linux..."
        
        if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y build-essential procps curl file git
        elif command -v yum >/dev/null 2>&1; then
            sudo yum groupinstall -y 'Development Tools'
            sudo yum install -y procps-ng curl file git
        elif command -v dnf >/dev/null 2>&1; then
            sudo dnf groupinstall -y 'Development Tools'
            sudo dnf install -y procps-ng curl file git
        else
            log_warn "Could not detect package manager. Please install build dependencies manually."
        fi
    fi
}

# Main installation process
main() {
    log_info "Starting Homebrew installation process..."
    
    # Check if already installed
    if check_homebrew_installed; then
        log_info "Homebrew is already installed. Skipping installation."
        exit 0
    fi
    
    # Install Linux dependencies if needed
    install_linux_dependencies
    
    # Install Homebrew
    install_homebrew
    
    # Verify installation
    if verify_homebrew; then
        log_info "🎉 Homebrew installation completed successfully!"
    else
        log_error "Homebrew installation failed. Please check the logs above."
        exit 1
    fi
}

# Run main function
main "$@"