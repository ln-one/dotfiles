#!/bin/bash
# 1Password CLI 安装脚本
# 由 Chezmoi 管理，仅在启用 1Password 功能时运行

{{- if and (hasKey . "features") .features.enable_1password (not (lookPath "op")) }}

set -euo pipefail

echo "🔐 安装 1Password CLI..."

# 检查是否已安装
if command -v op >/dev/null 2>&1; then
    echo "✅ 1Password CLI 已安装: $(op --version)"
    exit 0
fi

# 根据平台安装 1Password CLI
{{- if eq .chezmoi.os "darwin" }}
# macOS 安装
if command -v brew >/dev/null 2>&1; then
    echo "📦 使用 Homebrew 安装 1Password CLI..."
    brew install --cask 1password-cli
else
    echo "⚠️  Homebrew 未安装，请手动安装 1Password CLI"
    echo "   下载地址: https://app-updates.agilebits.com/product_history/CLI2"
    exit 1
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux 安装
echo "📦 安装 1Password CLI (Linux)..."

# 添加 1Password 官方 GPG 密钥
curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg

# 添加 1Password 官方仓库
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
    sudo tee /etc/apt/sources.list.d/1password.list

# 更新包列表并安装
sudo apt update
sudo apt install -y 1password-cli

{{- end }}

# 验证安装
if command -v op >/dev/null 2>&1; then
    echo "✅ 1Password CLI 安装成功: $(op --version)"
    echo ""
    echo "📝 下一步:"
    echo "   1. 运行 'op signin' 登录你的 1Password 账户"
    echo "   2. 确保你的密钥已存储在 1Password 中"
    echo "   3. 运行 'chezmoi apply' 生成密钥文件"
else
    echo "❌ 1Password CLI 安装失败"
    exit 1
fi

{{- else }}
echo "ℹ️  1Password 功能未启用，跳过 CLI 安装"
echo "   要启用，请在 .chezmoi.toml 中设置 features.enable_1password = true"
{{- end }}