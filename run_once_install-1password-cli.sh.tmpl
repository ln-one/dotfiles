#!/bin/bash
# 1Password CLI å®‰è£…è„šæœ¬
# ç”± Chezmoi ç®¡ç†ï¼Œä»…åœ¨å¯ç”¨ 1Password åŠŸèƒ½æ—¶è¿è¡Œ

{{- if and (hasKey . "features") .features.enable_1password (not (lookPath "op")) }}

set -euo pipefail

echo "ğŸ” å®‰è£… 1Password CLI..."

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if command -v op >/dev/null 2>&1; then
    echo "âœ… 1Password CLI å·²å®‰è£…: $(op --version)"
    exit 0
fi

# æ ¹æ®å¹³å°å®‰è£… 1Password CLI
{{- if eq .chezmoi.os "darwin" }}
# macOS å®‰è£…
if command -v brew >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ Homebrew å®‰è£… 1Password CLI..."
    brew install --cask 1password-cli
else
    echo "âš ï¸  Homebrew æœªå®‰è£…ï¼Œè¯·æ‰‹åŠ¨å®‰è£… 1Password CLI"
    echo "   ä¸‹è½½åœ°å€: https://app-updates.agilebits.com/product_history/CLI2"
    exit 1
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux å®‰è£…
echo "ğŸ“¦ å®‰è£… 1Password CLI (Linux)..."

# æ·»åŠ  1Password å®˜æ–¹ GPG å¯†é’¥
curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg

# æ·»åŠ  1Password å®˜æ–¹ä»“åº“
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
    sudo tee /etc/apt/sources.list.d/1password.list

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
sudo apt update
sudo apt install -y 1password-cli

{{- end }}

# éªŒè¯å®‰è£…
if command -v op >/dev/null 2>&1; then
    echo "âœ… 1Password CLI å®‰è£…æˆåŠŸ: $(op --version)"
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥:"
    echo "   1. è¿è¡Œ 'op signin' ç™»å½•ä½ çš„ 1Password è´¦æˆ·"
    echo "   2. ç¡®ä¿ä½ çš„å¯†é’¥å·²å­˜å‚¨åœ¨ 1Password ä¸­"
    echo "   3. è¿è¡Œ 'chezmoi apply' ç”Ÿæˆå¯†é’¥æ–‡ä»¶"
else
    echo "âŒ 1Password CLI å®‰è£…å¤±è´¥"
    exit 1
fi

{{- else }}
echo "â„¹ï¸  1Password åŠŸèƒ½æœªå¯ç”¨ï¼Œè·³è¿‡ CLI å®‰è£…"
echo "   è¦å¯ç”¨ï¼Œè¯·åœ¨ .chezmoi.toml ä¸­è®¾ç½® features.enable_1password = true"
{{- end }}