#!/bin/bash
# fnm (Fast Node Manager) 安装脚本
# 快速的 Node.js 版本管理器，替代 nvm
# Requirements: 8.4

{{- if .features.enable_node }}

set -euo pipefail

# 颜色定义
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# 日志函数
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "\n${BLUE}==>${NC} $1"; }

# 主函数
main() {
    log_step "安装 fnm (Fast Node Manager)..."
    
    # 检查 fnm 是否已安装
    if command -v fnm >/dev/null 2>&1; then
        log_success "✅ fnm 已安装"
        local fnm_version=$(fnm --version 2>/dev/null || echo "未知")
        log_info "当前版本: $fnm_version"
        return 0
    fi
    
    # 使用官方安装脚本安装 fnm
    log_info "正在下载 fnm 安装脚本..."
    if curl --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 -fsSL https://fnm.vercel.app/install | bash; then
        log_success "✅ fnm 安装成功"
        
        # 设置环境变量
        export PATH="$HOME/.local/bin:$PATH"
        
        # 验证安装
        if command -v fnm >/dev/null 2>&1; then
            local fnm_version=$(fnm --version 2>/dev/null || echo "未知")
            log_success "✅ fnm 版本: $fnm_version"
            log_info "fnm 安装位置: $(which fnm)"
            
            # 创建 .nvmrc 文件
            if [[ ! -f "$HOME/.nvmrc" ]]; then
                echo "lts/*" > "$HOME/.nvmrc"
                log_info "已创建 .nvmrc 配置文件"
            fi
            
            log_info ""
            log_info "使用说明:"
            log_info "  - 安装 Node.js LTS: fnm install --lts"
            log_info "  - 使用特定版本: fnm use <version>"
            log_info "  - 列出可用版本: fnm list-remote"
            log_info "  - 设置默认版本: fnm default <version>"
            log_info ""
            log_info "重新启动终端或运行 'source ~/.zshrc' 来激活 fnm"
        else
            log_error "❌ fnm 安装验证失败"
            exit 1
        fi
    else
        log_error "❌ fnm 安装失败"
        exit 1
    fi
}

# 执行主函数
main "$@"

{{- else }}
echo "跳过 fnm 安装 (Node.js 功能未启用)"
{{- end }}