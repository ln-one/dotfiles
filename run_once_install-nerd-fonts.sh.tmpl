#!/bin/bash
# ========================================
# Nerd Fonts å®‰è£…è„šæœ¬ (Chezmoi ç®¡ç†)
# ========================================
# å®‰è£… Nerd Fonts ä»¥æ”¯æŒ Starship å›¾æ ‡æ˜¾ç¤º

{{- if and (hasKey . "features") .features.enable_starship }}

set -euo pipefail

echo "ğŸ”¤ å¼€å§‹å®‰è£… Nerd Fonts..."

# åˆ›å»ºå­—ä½“ç›®å½•
FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£… Nerd Fonts
if fc-list | grep -i "nerd\|powerline" >/dev/null 2>&1; then
    echo "âœ… Nerd Fonts å·²å®‰è£…"
    echo "å·²å®‰è£…çš„ Nerd Fonts:"
    fc-list | grep -i "nerd\|powerline" | head -3 || true
    exit 0
fi

echo "ğŸ“¥ ä¸‹è½½æ¨èçš„ Nerd Fonts..."

# æ¨èçš„å­—ä½“åˆ—è¡¨ (è½»é‡çº§ä½†åŠŸèƒ½å®Œæ•´)
declare -A FONTS=(
    ["FiraCode"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
    ["JetBrainsMono"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
    ["Hack"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
)

# æ ¹æ®ç¯å¢ƒé€‰æ‹©è¦å®‰è£…çš„å­—ä½“
{{- if eq .environment "desktop" }}
# æ¡Œé¢ç¯å¢ƒ - å®‰è£…å¤šä¸ªå­—ä½“é€‰æ‹©
FONTS_TO_INSTALL=("FiraCode" "JetBrainsMono")
{{- else }}
# è¿œç¨‹/æœåŠ¡å™¨ç¯å¢ƒ - åªå®‰è£…ä¸€ä¸ªè½»é‡å­—ä½“
FONTS_TO_INSTALL=("Hack")
{{- end }}

installed_count=0

for font_name in "${FONTS_TO_INSTALL[@]}"; do
    font_url="${FONTS[${font_name}]}"
    
    echo "ğŸ“¦ å®‰è£… ${font_name} Nerd Font..."
    
    # ä¸‹è½½å­—ä½“
    temp_file="/tmp/${font_name}.zip"
    if curl -L -o "$temp_file" "$font_url"; then
        echo "âœ… ${font_name} ä¸‹è½½å®Œæˆ"
        
        # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
        temp_dir="/tmp/${font_name}_extract"
        mkdir -p "$temp_dir"
        
        if unzip -q "$temp_file" -d "$temp_dir"; then
            # å¤åˆ¶ TTF æ–‡ä»¶åˆ°å­—ä½“ç›®å½•
            find "$temp_dir" -name "*.ttf" -exec cp {} "$FONT_DIR/" \;
            
            echo "âœ… ${font_name} å®‰è£…å®Œæˆ"
            installed_count=$((installed_count + 1))
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "$temp_file" "$temp_dir"
        else
            echo "âŒ ${font_name} è§£å‹å¤±è´¥"
            rm -f "$temp_file"
        fi
    else
        echo "âŒ ${font_name} ä¸‹è½½å¤±è´¥"
    fi
done

# åˆ·æ–°å­—ä½“ç¼“å­˜
if command -v fc-cache >/dev/null 2>&1; then
    echo "ğŸ”„ åˆ·æ–°å­—ä½“ç¼“å­˜..."
    fc-cache -fv "$FONT_DIR" >/dev/null 2>&1
    echo "âœ… å­—ä½“ç¼“å­˜å·²åˆ·æ–°"
fi

# å®‰è£…æ€»ç»“
echo ""
echo "=========================================="
echo "ğŸ‰ Nerd Fonts å®‰è£…å®Œæˆï¼"
echo "æˆåŠŸå®‰è£…: $installed_count ä¸ªå­—ä½“"

if [ $installed_count -gt 0 ]; then
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:"
    echo "1. é‡å¯ç»ˆç«¯åº”ç”¨ç¨‹åº"
    echo "2. åœ¨ç»ˆç«¯è®¾ç½®ä¸­é€‰æ‹© Nerd Font:"
    {{- if eq .environment "desktop" }}
    echo "   â€¢ æ¨è: FiraCode Nerd Font"
    echo "   â€¢ å¤‡é€‰: JetBrains Mono Nerd Font"
    {{- else }}
    echo "   â€¢ æ¨è: Hack Nerd Font"
    {{- end }}
    echo "3. é‡æ–°å¯åŠ¨ shell æ¥æŸ¥çœ‹å›¾æ ‡æ•ˆæœ"
    
    echo ""
    echo "ğŸ”§ ç»ˆç«¯é…ç½®æŒ‡å—:"
    echo "â€¢ GNOME Terminal: é¦–é€‰é¡¹ â†’ é…ç½®æ–‡ä»¶ â†’ æ–‡æœ¬ â†’ è‡ªå®šä¹‰å­—ä½“"
    echo "â€¢ Konsole: è®¾ç½® â†’ ç¼–è¾‘å½“å‰é…ç½®æ–‡ä»¶ â†’ å¤–è§‚ â†’ å­—ä½“"
    echo "â€¢ Alacritty: ç¼–è¾‘ ~/.config/alacritty/alacritty.yml"
    echo "â€¢ Kitty: ç¼–è¾‘ ~/.config/kitty/kitty.conf"
    echo "â€¢ Terminator: å³é”® â†’ é¦–é€‰é¡¹ â†’ é…ç½®æ–‡ä»¶ â†’ å­—ä½“"
    
    echo ""
    echo "âœ¨ å®‰è£…çš„å­—ä½“:"
    fc-list | grep -i "nerd" | head -5 || true
else
    echo "âŒ æ²¡æœ‰å­—ä½“å®‰è£…æˆåŠŸï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
fi

echo "=========================================="

{{- else }}
echo "â„¹ï¸  Starship åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡ Nerd Fonts å®‰è£…"
{{- end }}