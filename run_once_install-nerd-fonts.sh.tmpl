#!/bin/bash
# ========================================
# Nerd Fonts 安装脚本 (Chezmoi 管理)
# ========================================
# 安装 Nerd Fonts 以支持 Starship 图标显示

{{- if and (hasKey . "features") .features.enable_starship }}

set -euo pipefail

echo "🔤 开始安装 Nerd Fonts..."

# 创建字体目录
FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"

# 检查是否已安装 Nerd Fonts
if fc-list | grep -i "nerd\|powerline" >/dev/null 2>&1; then
    echo "✅ Nerd Fonts 已安装"
    echo "已安装的 Nerd Fonts:"
    fc-list | grep -i "nerd\|powerline" | head -3 || true
    exit 0
fi

echo "📥 下载推荐的 Nerd Fonts..."

# 推荐的字体列表 (轻量级但功能完整)
declare -A FONTS=(
    ["FiraCode"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
    ["JetBrainsMono"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
    ["Hack"]="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
)

# 根据环境选择要安装的字体
{{- if eq .environment "desktop" }}
# 桌面环境 - 安装多个字体选择
FONTS_TO_INSTALL=("FiraCode" "JetBrainsMono")
{{- else }}
# 远程/服务器环境 - 只安装一个轻量字体
FONTS_TO_INSTALL=("Hack")
{{- end }}

installed_count=0

for font_name in "${FONTS_TO_INSTALL[@]}"; do
    font_url="${FONTS[${font_name}]}"
    
    echo "📦 安装 ${font_name} Nerd Font..."
    
    # 下载字体
    temp_file="/tmp/${font_name}.zip"
    if curl -L -o "$temp_file" "$font_url"; then
        echo "✅ ${font_name} 下载完成"
        
        # 解压到临时目录
        temp_dir="/tmp/${font_name}_extract"
        mkdir -p "$temp_dir"
        
        if unzip -q "$temp_file" -d "$temp_dir"; then
            # 复制 TTF 文件到字体目录
            find "$temp_dir" -name "*.ttf" -exec cp {} "$FONT_DIR/" \;
            
            echo "✅ ${font_name} 安装完成"
            installed_count=$((installed_count + 1))
            
            # 清理临时文件
            rm -rf "$temp_file" "$temp_dir"
        else
            echo "❌ ${font_name} 解压失败"
            rm -f "$temp_file"
        fi
    else
        echo "❌ ${font_name} 下载失败"
    fi
done

# 刷新字体缓存
if command -v fc-cache >/dev/null 2>&1; then
    echo "🔄 刷新字体缓存..."
    fc-cache -fv "$FONT_DIR" >/dev/null 2>&1
    echo "✅ 字体缓存已刷新"
fi

# 安装总结
echo ""
echo "=========================================="
echo "🎉 Nerd Fonts 安装完成！"
echo "成功安装: $installed_count 个字体"

if [ $installed_count -gt 0 ]; then
    echo ""
    echo "📝 下一步操作:"
    echo "1. 重启终端应用程序"
    echo "2. 在终端设置中选择 Nerd Font:"
    {{- if eq .environment "desktop" }}
    echo "   • 推荐: FiraCode Nerd Font"
    echo "   • 备选: JetBrains Mono Nerd Font"
    {{- else }}
    echo "   • 推荐: Hack Nerd Font"
    {{- end }}
    echo "3. 重新启动 shell 来查看图标效果"
    
    echo ""
    echo "🔧 终端配置指南:"
    echo "• GNOME Terminal: 首选项 → 配置文件 → 文本 → 自定义字体"
    echo "• Konsole: 设置 → 编辑当前配置文件 → 外观 → 字体"
    echo "• Alacritty: 编辑 ~/.config/alacritty/alacritty.yml"
    echo "• Kitty: 编辑 ~/.config/kitty/kitty.conf"
    echo "• Terminator: 右键 → 首选项 → 配置文件 → 字体"
    
    echo ""
    echo "✨ 安装的字体:"
    fc-list | grep -i "nerd" | head -5 || true
else
    echo "❌ 没有字体安装成功，请检查网络连接"
fi

echo "=========================================="

{{- else }}
echo "ℹ️  Starship 功能已禁用，跳过 Nerd Fonts 安装"
{{- end }}