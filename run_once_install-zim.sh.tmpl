#!/bin/bash
# ========================================
# Zim æ¡†æ¶å®‰è£…è„šæœ¬ (Chezmoi ç®¡ç†)
# ========================================
# è‡ªåŠ¨å®‰è£…å’Œé…ç½® Zim æ¡†æ¶
# åªåœ¨å¯ç”¨ Zim åŠŸèƒ½æ—¶è¿è¡Œ

{{- if and (hasKey . "features") .features.enable_zim }}

set -euo pipefail

echo "ğŸš€ å¼€å§‹å®‰è£… Zim æ¡†æ¶..."

# è®¾ç½® Zim ç›¸å…³è·¯å¾„
ZIM_HOME="${ZDOTDIR:-${HOME}}/.zim"
ZIM_CONFIG_FILE="${ZDOTDIR:-${HOME}}/.zimrc"

# æ£€æŸ¥å¿…éœ€å·¥å…·
check_requirements() {
    local missing_tools=()
    
    if ! command -v zsh >/dev/null 2>&1; then
        missing_tools+=("zsh")
    fi
    
    if ! command -v curl >/dev/null 2>&1 && ! command -v wget >/dev/null 2>&1; then
        missing_tools+=("curl æˆ– wget")
    fi
    
    if ! command -v git >/dev/null 2>&1; then
        missing_tools+=("git")
    fi
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        echo "âŒ é”™è¯¯: ç¼ºå°‘å¿…éœ€å·¥å…·: ${missing_tools[*]}"
        echo "è¯·å…ˆå®‰è£…è¿™äº›å·¥å…·åå†è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
create_directories() {
    echo "ğŸ“ åˆ›å»º Zim ç›®å½•ç»“æ„..."
    
    # åˆ›å»º ZIM_HOME ç›®å½•
    if [ ! -d "$ZIM_HOME" ]; then
        mkdir -p "$ZIM_HOME"
        echo "âœ… åˆ›å»ºç›®å½•: $ZIM_HOME"
    fi
    
    # åˆ›å»ºæ¨¡å—ç›®å½•
    if [ ! -d "$ZIM_HOME/modules" ]; then
        mkdir -p "$ZIM_HOME/modules"
        echo "âœ… åˆ›å»ºç›®å½•: $ZIM_HOME/modules"
    fi
}

# ä¸‹è½½ Zim æ¡†æ¶ç®¡ç†å™¨
install_zimfw() {
    local zimfw_path="$ZIM_HOME/zimfw.zsh"
    
    if [ -f "$zimfw_path" ]; then
        echo "âœ… Zim æ¡†æ¶ç®¡ç†å™¨å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ›´æ–°..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° (å¦‚æœæ–‡ä»¶è¶…è¿‡7å¤©åˆ™æ›´æ–°)
        if [ -n "$(find "$zimfw_path" -mtime +7 2>/dev/null)" ]; then
            echo "ğŸ”„ æ›´æ–° Zim æ¡†æ¶ç®¡ç†å™¨..."
            download_zimfw "$zimfw_path"
        else
            echo "âœ… Zim æ¡†æ¶ç®¡ç†å™¨æ˜¯æœ€æ–°çš„"
        fi
    else
        echo "ğŸ“¥ ä¸‹è½½ Zim æ¡†æ¶ç®¡ç†å™¨..."
        download_zimfw "$zimfw_path"
    fi
}

# ä¸‹è½½ zimfw.zsh çš„å…·ä½“å®ç°
download_zimfw() {
    local zimfw_path="$1"
    local zimfw_url="https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh"
    
    if command -v curl >/dev/null 2>&1; then
        curl -fsSL --create-dirs -o "$zimfw_path" "$zimfw_url" || {
            echo "âŒ ä½¿ç”¨ curl ä¸‹è½½ Zim æ¡†æ¶ç®¡ç†å™¨å¤±è´¥"
            return 1
        }
    elif command -v wget >/dev/null 2>&1; then
        wget -nv -O "$zimfw_path" "$zimfw_url" || {
            echo "âŒ ä½¿ç”¨ wget ä¸‹è½½ Zim æ¡†æ¶ç®¡ç†å™¨å¤±è´¥"
            return 1
        }
    else
        echo "âŒ é”™è¯¯: éœ€è¦ curl æˆ– wget æ¥ä¸‹è½½ Zim æ¡†æ¶ç®¡ç†å™¨"
        return 1
    fi
    
    # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
    if [ ! -f "$zimfw_path" ] || [ ! -s "$zimfw_path" ]; then
        echo "âŒ Zim æ¡†æ¶ç®¡ç†å™¨ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
        return 1
    fi
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x "$zimfw_path"
    echo "âœ… Zim æ¡†æ¶ç®¡ç†å™¨ä¸‹è½½å®Œæˆ"
}

# éªŒè¯ Zim é…ç½®æ–‡ä»¶
verify_zimrc() {
    if [ ! -f "$ZIM_CONFIG_FILE" ]; then
        echo "âš ï¸  è­¦å‘Š: .zimrc é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        echo "   Chezmoi åº”è¯¥ä¼šåˆ›å»ºæ­¤æ–‡ä»¶ï¼Œè¯·ç¡®ä¿è¿è¡Œäº† 'chezmoi apply'"
        return 1
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åŒ…å«åŸºæœ¬æ¨¡å—
    if ! grep -q "zmodule" "$ZIM_CONFIG_FILE"; then
        echo "âš ï¸  è­¦å‘Š: .zimrc é…ç½®æ–‡ä»¶ä¼¼ä¹ä¸åŒ…å«æ¨¡å—å®šä¹‰"
        return 1
    fi
    
    echo "âœ… .zimrc é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
}

# åˆå§‹åŒ– Zim æ¨¡å—
initialize_zim() {
    echo "ğŸ”§ åˆå§‹åŒ– Zim æ¨¡å—..."
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    export ZIM_HOME
    
    # è¿è¡Œ zimfw åˆå§‹åŒ–
    if [ -f "$ZIM_HOME/zimfw.zsh" ]; then
        # ä½¿ç”¨ zsh è¿è¡Œ zimfw ä»¥é¿å… bash å…¼å®¹æ€§é—®é¢˜
        zsh -c "
            export ZIM_HOME='$ZIM_HOME'
            source '$ZIM_HOME/zimfw.zsh'
            zimfw install
            zimfw init
        " || {
            echo "âŒ Zim æ¨¡å—åˆå§‹åŒ–å¤±è´¥"
            return 1
        }
        
        echo "âœ… Zim æ¨¡å—åˆå§‹åŒ–å®Œæˆ"
    else
        echo "âŒ é”™è¯¯: zimfw.zsh ä¸å­˜åœ¨ï¼Œæ— æ³•åˆå§‹åŒ–æ¨¡å—"
        return 1
    fi
}

# éªŒè¯å®‰è£…ç»“æœ
verify_installation() {
    echo "ğŸ” éªŒè¯ Zim å®‰è£…..."
    
    local errors=0
    
    # æ£€æŸ¥ zimfw.zsh
    if [ ! -f "$ZIM_HOME/zimfw.zsh" ]; then
        echo "âŒ zimfw.zsh ä¸å­˜åœ¨"
        ((errors++))
    fi
    
    # æ£€æŸ¥ init.zsh
    if [ ! -f "$ZIM_HOME/init.zsh" ]; then
        echo "âŒ init.zsh ä¸å­˜åœ¨ï¼Œæ¨¡å—å¯èƒ½æœªæ­£ç¡®åˆå§‹åŒ–"
        ((errors++))
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [ ! -f "$ZIM_CONFIG_FILE" ]; then
        echo "âŒ .zimrc é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        ((errors++))
    fi
    
    # æ£€æŸ¥ fzf é›†æˆ (å¦‚æœå¯ç”¨)
    {{- if and (hasKey . "features") .features.enable_fzf }}
    if command -v fzf >/dev/null 2>&1; then
        if fzf --help 2>/dev/null | grep -q -- '--zsh'; then
            echo "âœ… fzf æ”¯æŒæ–°çš„ --zsh é›†æˆé€‰é¡¹"
        else
            echo "âš ï¸  fzf ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿé›†æˆæ–¹å¼"
        fi
    else
        echo "âš ï¸  fzf æœªå®‰è£…ï¼Œfzf åŠŸèƒ½å°†ä¸å¯ç”¨"
    fi
    {{- end }}
    
    if [ $errors -eq 0 ]; then
        echo "âœ… Zim å®‰è£…éªŒè¯é€šè¿‡"
        return 0
    else
        echo "âŒ Zim å®‰è£…éªŒè¯å¤±è´¥ï¼Œå‘ç° $errors ä¸ªé—®é¢˜"
        return 1
    fi
}

# å¹³å°ç‰¹å®šçš„å®‰è£…å¤„ç†
handle_platform_specific() {
    echo "ğŸ–¥ï¸  å¤„ç†å¹³å°ç‰¹å®šé…ç½®..."
    
    case "{{ .chezmoi.os }}" in
        "darwin")
            echo "ğŸ“± æ£€æµ‹åˆ° macOS å¹³å°"
            # macOS ç‰¹å®šå¤„ç†
            if [ ! -d "/usr/local/share/zsh/site-functions" ] && [ ! -d "/opt/homebrew/share/zsh/site-functions" ]; then
                echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° zsh è¡¥å…¨ç›®å½•ï¼ŒæŸäº›è¡¥å…¨åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨"
            fi
            ;;
        "linux")
            echo "ğŸ§ æ£€æµ‹åˆ° Linux å¹³å°"
            # Linux ç‰¹å®šå¤„ç†
            case "{{ .package_manager }}" in
                "apt")
                    echo "ğŸ“¦ æ£€æµ‹åˆ° APT åŒ…ç®¡ç†å™¨"
                    ;;
                "yum")
                    echo "ğŸ“¦ æ£€æµ‹åˆ° YUM åŒ…ç®¡ç†å™¨"
                    ;;
                *)
                    echo "ğŸ“¦ æœªçŸ¥åŒ…ç®¡ç†å™¨: {{ .package_manager }}"
                    ;;
            esac
            ;;
        *)
            echo "â“ æœªçŸ¥å¹³å°: {{ .chezmoi.os }}"
            ;;
    esac
}

# ç¯å¢ƒç‰¹å®šçš„ä¼˜åŒ–
handle_environment_specific() {
    echo "ğŸŒ å¤„ç†ç¯å¢ƒç‰¹å®šä¼˜åŒ–..."
    
    case "{{ .environment }}" in
        "remote")
            echo "ğŸ”— æ£€æµ‹åˆ°è¿œç¨‹ SSH ç¯å¢ƒï¼Œä½¿ç”¨è½»é‡åŒ–é…ç½®"
            # è¿œç¨‹ç¯å¢ƒå¯èƒ½éœ€è¦æ›´å°‘çš„æ¨¡å—æˆ–æ›´å¿«çš„å¯åŠ¨
            ;;
        "container")
            echo "ğŸ³ æ£€æµ‹åˆ°å®¹å™¨ç¯å¢ƒï¼Œä½¿ç”¨æœ€å°åŒ–é…ç½®"
            # å®¹å™¨ç¯å¢ƒé€šå¸¸éœ€è¦æœ€å°åŒ–çš„é…ç½®
            ;;
        "wsl")
            echo "ğŸªŸ æ£€æµ‹åˆ° WSL ç¯å¢ƒï¼Œä½¿ç”¨æ··åˆä¼˜åŒ–é…ç½®"
            # WSL ç¯å¢ƒå¯èƒ½éœ€è¦ç‰¹æ®Šçš„è·¯å¾„å¤„ç†
            ;;
        "desktop")
            echo "ğŸ–¥ï¸  æ£€æµ‹åˆ°æ¡Œé¢ç¯å¢ƒï¼Œä½¿ç”¨å®Œæ•´é…ç½®"
            # æ¡Œé¢ç¯å¢ƒå¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
            ;;
        *)
            echo "â“ æœªçŸ¥ç¯å¢ƒ: {{ .environment }}"
            ;;
    esac
}

# ä¸»å®‰è£…æµç¨‹
main() {
    echo "ğŸ¯ å¼€å§‹ Zim æ¡†æ¶å®‰è£…æµç¨‹..."
    echo "   ç¯å¢ƒ: {{ .environment }}"
    echo "   å¹³å°: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
    echo "   ZIM_HOME: $ZIM_HOME"
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_requirements
    create_directories
    handle_platform_specific
    handle_environment_specific
    install_zimfw
    
    # åªæœ‰åœ¨é…ç½®æ–‡ä»¶å­˜åœ¨æ—¶æ‰åˆå§‹åŒ–
    if verify_zimrc; then
        initialize_zim
    else
        echo "âš ï¸  è·³è¿‡æ¨¡å—åˆå§‹åŒ–ï¼Œç­‰å¾… Chezmoi åˆ›å»ºé…ç½®æ–‡ä»¶"
        echo "   è¯·è¿è¡Œ 'chezmoi apply' åå†è¿è¡Œ 'zsh -c \"source ~/.zshrc\"'"
    fi
    
    # éªŒè¯å®‰è£…
    if verify_installation; then
        echo "ğŸ‰ Zim æ¡†æ¶å®‰è£…å®Œæˆï¼"
        echo ""
        echo "ğŸ“‹ åç»­æ­¥éª¤:"
        echo "   1. è¿è¡Œ 'chezmoi apply' ç¡®ä¿æ‰€æœ‰é…ç½®æ–‡ä»¶å·²åº”ç”¨"
        echo "   2. é‡æ–°å¯åŠ¨ç»ˆç«¯æˆ–è¿è¡Œ 'source ~/.zshrc'"
        echo "   3. å¦‚éœ€æ›´æ–°æ¨¡å—ï¼Œè¿è¡Œ 'zimfw update'"
        echo ""
        echo "ğŸ’¡ æç¤º:"
        echo "   - é…ç½®æ–‡ä»¶ä½ç½®: $ZIM_CONFIG_FILE"
        echo "   - Zim å®‰è£…ç›®å½•: $ZIM_HOME"
        echo "   - æŸ¥çœ‹å¯ç”¨å‘½ä»¤: zimfw help"
    else
        echo "âŒ Zim æ¡†æ¶å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
        echo "   è¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯å¹¶é‡æ–°è¿è¡Œå®‰è£…"
        exit 1
    fi
}

# è¿è¡Œä¸»å‡½æ•°
main

{{- else }}
echo "â„¹ï¸  Zim åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡å®‰è£…"
echo "   è¦å¯ç”¨ Zimï¼Œè¯·åœ¨ .chezmoi.toml.tmpl ä¸­è®¾ç½® enable_zim = true"
{{- end }}