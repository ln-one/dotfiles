# ========================================
# Bash Configuration (Chezmoi Template)
# ========================================
# 现代化 Bash 配置，充分利用 chezmoi 模块化设计
# 目标平台: {{ .chezmoi.os }}/{{ .chezmoi.arch }}
# 环境类型: {{ .environment }}
# ========================================

# 非交互式 shell 直接退出
case $- in
    *i*) ;;
      *) return;;
esac

# ========================================
# 加载环境变量模块
# ========================================
{{ includeTemplate "core/environment.sh" . }}

# ========================================
# Bash 特定配置
# ========================================
# 历史配置 (和 zsh 保持一致)
HISTCONTROL=ignoreboth
HISTSIZE=50000
HISTFILESIZE=50000

# Bash 选项
shopt -s histappend
shopt -s checkwinsize
shopt -s globstar 2>/dev/null

# 设置 chroot 标识
if [ -z "${debian_chroot:-}" ] && [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

# ========================================
# 社区工具集成 (Bash)
# ========================================

# Starship 提示符配置 (如果启用且支持 Bash)
{{ includeTemplate "core/starship-config.sh" . }}

# 如果没有启用 Starship，使用默认 Bash 提示符
{{- if not .features.enable_starship }}
# ========================================
# 默认彩色提示符配置
# ========================================
{{- if eq .environment "remote" }}
# 远程环境 - 简洁但有颜色的提示符
if [ "$TERM" != "dumb" ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
{{- else }}
# 本地环境 - 丰富的彩色提示符
case "$TERM" in
    xterm-color|*-256color) color_prompt=yes;;
esac

if [ "$color_prompt" = yes ]; then
    # 彩色提示符，包含 git 分支信息
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]'
    # 添加 git 分支显示 (如果在 git 仓库中)
    if command -v git >/dev/null 2>&1; then
        PS1="$PS1"'\[\033[01;33m\]$(__git_ps1 " (%s)")\[\033[00m\]'
    fi
    PS1="$PS1"'\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
{{- end }}

unset color_prompt
{{- end }}

# 设置终端标题
case "$TERM" in
xterm*|rxvt*)
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    ;;
*)
    ;;
esac

# ========================================
# 加载共享配置模块
# ========================================
{{ includeTemplate "shell-common.sh" . }}

# ========================================
# Bash 补全配置
# ========================================
if ! shopt -oq posix; then
    {{- if eq .chezmoi.os "darwin" }}
    [ -r "/opt/homebrew/etc/profile.d/bash_completion.sh" ] && source "/opt/homebrew/etc/profile.d/bash_completion.sh"
    {{- else if eq .chezmoi.os "linux" }}
    [ -f /usr/share/bash-completion/bash_completion ] && source /usr/share/bash-completion/bash_completion
    {{- end }}
fi

# ========================================
# 本地自定义配置
# ========================================
[ -f ~/.bashrc.local ] && source ~/.bashrc.local

# Chezmoi 管理标记 - 请勿直接编辑此文件
# 要修改配置，请编辑: {{ .chezmoi.sourceDir }}/dot_bashrc.tmpl