# PowerShell Environment Configuration
# Windows-specific environment variables and 1Password integration

# Basic environment variables
$env:EDITOR = "{{ .preferences.editor }}"
$env:VISUAL = "{{ .preferences.editor }}"
$env:PAGER = "less"

# Language and locale
$env:LANG = "en_US.UTF-8"

{{- if .features.enable_1password }}
# 1Password CLI and SSH Agent integration
if (Get-Command op -ErrorAction SilentlyContinue) {
    # 1Password SSH Agent socket path on Windows
    $sshAgentSock = "$env:USERPROFILE\AppData\Local\1Password\agent.sock"
    
    if (Test-Path $sshAgentSock) {
        $env:SSH_AUTH_SOCK = $sshAgentSock
        Write-Host "1Password SSH Agent configured" -ForegroundColor Green
    }
    
    # Load 1Password secrets if available
    $secretsFile = "$env:USERPROFILE\.secrets.ps1"
    if (Test-Path $secretsFile) {
        . $secretsFile
        Write-Host "1Password secrets loaded" -ForegroundColor Green
    }
}
{{- end }}

{{- if and .features.enable_proxy .proxy.enabled }}
# Proxy configuration
{{- $http_proxy := .proxy.http_proxy | default "" }}
{{- $https_proxy := .proxy.https_proxy | default "" }}
{{- if $http_proxy }}
$env:HTTP_PROXY = "{{ $http_proxy }}"
$env:http_proxy = "{{ $http_proxy }}"
{{- end }}
{{- if $https_proxy }}
$env:HTTPS_PROXY = "{{ $https_proxy }}"
$env:https_proxy = "{{ $https_proxy }}"
{{- end }}
$env:NO_PROXY = "localhost,127.0.0.1,::1,.local"
$env:no_proxy = $env:NO_PROXY
{{- end }}

{{- if .features.enable_ai_tools }}
# AI tools configuration
if ($env:OPENAI_API_KEY) {
    Write-Host "OpenAI API configured" -ForegroundColor Green
}
{{- end }}

# Windows-specific optimizations
$env:POWERSHELL_TELEMETRY_OPTOUT = 1
$env:DOTNET_CLI_TELEMETRY_OPTOUT = 1

# Ensure local bin directory exists and is in PATH
$localBin = "$env:USERPROFILE\.local\bin"
if (-not (Test-Path $localBin)) {
    New-Item -ItemType Directory -Path $localBin -Force | Out-Null
}

if ($env:PATH -notlike "*$localBin*") {
    $env:PATH = "$localBin;$env:PATH"
}