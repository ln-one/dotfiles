#!/bin/bash
# ========================================
# Starship æç¤ºç¬¦å®‰è£…è„šæœ¬ (Chezmoi ç®¡ç†)
# ========================================
# å®‰è£…ç°ä»£åŒ–çš„è·¨ Shell æç¤ºç¬¦

{{- if and (hasKey . "features") .features.enable_starship }}

set -euo pipefail

echo "ğŸš€ å¼€å§‹å®‰è£… Starship æç¤ºç¬¦..."

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if command -v starship >/dev/null 2>&1; then
    echo "âœ… Starship å·²å®‰è£…ï¼Œç‰ˆæœ¬: $(starship --version)"
    exit 0
fi

# æ£€æŸ¥å¿…éœ€å·¥å…·
if ! command -v curl >/dev/null 2>&1; then
    echo "âŒ é”™è¯¯: éœ€è¦ curl æ¥ä¸‹è½½ Starship"
    exit 1
fi

# æ ¹æ®å¹³å°é€‰æ‹©å®‰è£…æ–¹æ³•
{{- if eq .chezmoi.os "darwin" }}
# macOS: ä¼˜å…ˆä½¿ç”¨ Homebrew
if command -v brew >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ Homebrew å®‰è£… Starship..."
    brew install starship || {
        echo "âš ï¸  Homebrew å®‰è£…å¤±è´¥ï¼Œå°è¯•å®˜æ–¹å®‰è£…è„šæœ¬..."
        curl -sS https://starship.rs/install.sh | sh -s -- --yes
    }
else
    echo "ğŸ“¥ ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬..."
    curl -sS https://starship.rs/install.sh | sh -s -- --yes
fi
{{- else if eq .chezmoi.os "linux" }}
# Linux: æ£€æŸ¥åŒ…ç®¡ç†å™¨
if command -v brew >/dev/null 2>&1; then
    echo "ğŸ“¦ ä½¿ç”¨ Homebrew å®‰è£… Starship..."
    brew install starship
elif command -v apt >/dev/null 2>&1; then
    echo "ğŸ“¦ å°è¯•ä½¿ç”¨ apt å®‰è£… Starship..."
    # æ£€æŸ¥æ˜¯å¦åœ¨aptä»“åº“ä¸­å¯ç”¨
    if apt-cache search starship | grep -q "^starship "; then
        sudo apt update && sudo apt install -y starship
    else
        echo "ğŸ“¥ apt ä¸­æ—  Starshipï¼Œä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬..."
        curl -sS https://starship.rs/install.sh | sh -s -- --yes
    fi
else
    echo "ğŸ“¥ ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬..."
    curl -sS https://starship.rs/install.sh | sh -s -- --yes
fi
{{- end }}

# éªŒè¯å®‰è£…
if command -v starship >/dev/null 2>&1; then
    echo "âœ… Starship å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: $(starship --version)"
    echo "ğŸ‰ Starship é…ç½®å®Œæˆï¼é‡æ–°å¯åŠ¨ç»ˆç«¯æ¥åº”ç”¨æ›´æ”¹"
else
    echo "âŒ Starship å®‰è£…å¤±è´¥"
    exit 1
fi

{{- else }}
echo "â„¹ï¸  Starship åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡å®‰è£…"
{{- end }}